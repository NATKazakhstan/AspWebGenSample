/*
 * Generated by: Sergey.Shpakovskiy
 * Generated at: 1.0.0.2
 * Copyright © JSC NAT Kazakhstan 2011
 */
#pragma warning disable

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Data.Common;
using System.Data.Linq;
using System.Data.Linq.Mapping;
using System.Data.SqlClient;
using System.Drawing.Design;
using System.Globalization;
using System.Linq;
using System.Security.Principal;
using System.Text;
using System.Xml.Linq;
using System.Web;
using System.Web.Compilation;
using System.Web.Script.Serialization;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.IO;
using System.Net.Mail;
using System.Net;
using System.Collections.Specialized;
using System.Web.Configuration;
using SampleDictionaries.Properties;


using Nat.Tools.Specific;
using Nat.Web.Controls;
using Nat.Web.Controls.BaseLogic;
using Nat.Web.Controls.Data;
using Nat.Web.Controls.DateTimeControls;
using Nat.Web.Controls.GenerationClasses;
using Nat.Web.Controls.GenerationClasses.Data;
using Nat.Web.Controls.GenerationClasses.Navigator;
using Nat.Web.Controls.HistoryFilters;
using Nat.Web.Controls.Preview;
using Nat.Web.Controls.SelectValues;
using Nat.Web.Tools;
using Nat.Web.Tools.Security;
using Nat.Web.Tools.WorkFlow;
using AccessOptions = SampleDictionaries.MyProductsAccessOptions;
using TableResources = SampleDictionaries.Properties.TableResources;

using Nat.Web.Tools.MailMessageContent;
using SampleDictionaries.Security;
using Nat.Web.Tools.ExtNet;
using Nat.Web.Tools.ExtNet.Extenders;
using Nat.Web.Tools.ExtNet.ExtNetConfig;
using Ext.Net;
using NullableTextBox = Ext.Net.NumberField;
using TextBox = Ext.Net.TextField;
using Label = Ext.Net.Label;
using DropDownListExt = Ext.Net.ComboBox;
using CheckBox = Ext.Net.Checkbox;
using RadioButton = Ext.Net.Radio;
using RadioButtonList = Ext.Net.RadioGroup;
using ImageButton = Ext.Net.ImageButton;
using HyperLink = Ext.Net.HyperLink;
using LinkButton = Ext.Net.LinkButton;
using DatePicker = Ext.Net.DateField;
using Panel = Ext.Net.Panel;
using Container = Ext.Net.Container;
using Newtonsoft.Json.Linq;
using AdditionalButtons = Nat.Web.Controls.ExtNet.AdditionalButtons;
using BrowseFilterParameters = Nat.Web.Tools.ExtNet.ExtNetBrowseFilterParameters;
using DBDataContext = SampleDictionaries.DBDataContext;

namespace SampleDictionaries.UserControls
{
    /// <summary>
    /// Контрол для просмотра, редактирования и добавления записей таблицы "Мои товары" (MyProducts)
    /// </summary>
    [DefaultEvent("SelectedIndexChanged")]
    [ControlValueProperty("SelectedValue")]
    public partial class MyProductsEdit : Nat.Web.Controls.ExtNet.Generation.AbstractUserControl, IAccessControl, IScriptControl
    {
        #region Fields

        private DBDataContext _db;
        private long? refMyProducts;
        private IEnumerable<ILogic> logics = new ILogic[] {  };
        private bool _isStartAction;
        private List<string> _addErrorMessages;
        private ControlInfo _info;
        private bool editlogicExecuted;
        private bool readlogicExecuted;
        private bool insertlogicExecuted;
        private bool _setDefaultValues;
        private bool _isNoPermit;
        private bool _selectedRowInited;
        private MyProductsJournalDataSourceView.Row _selectedRow;
        private MyProduct _currentRow;
        private long? refLogMessage;
        private bool selectedValueInitialized;

        #endregion

        #region Partials

        partial void ReadLogic();
        partial void EditLogic();
        partial void InsertLogic();
        partial void EditInsertLogic();
        partial void Logic();
        partial void OnUpdating(MyProduct newItem, MyProduct originalItem);
        partial void OnInserting(MyProduct newItem);
        partial void OnContextCreating(LinqDataSourceContextEventArgs e);
        partial void OnUpdated(LinqDataSourceStatusEventArgs e);
        partial void OnInserted(LinqDataSourceStatusEventArgs e);
        partial void OnDispose();
        partial void UpdateRefMyProducts(MyProduct row);
        partial void GetDefaultProperties(Dictionary<Type, List<string>> typeProperies);
        partial void GenerateAdditionalButtons(AdditionalButtons buttons);
        partial void GetBrowseFilterParameters(string fieldName, BrowseFilterParameters parameters);
        partial void GetValidators_Name(ValidateInformation validateInformation);
        partial void GetValidators_CreationDate(ValidateInformation validateInformation);
        partial void GetValidators_Price(ValidateInformation validateInformation);
        partial void GetValidators_Amount(ValidateInformation validateInformation);
        partial void ChangeLogTypeAdd(ref LogMessageType logType);
        partial void ChangeLogTypeLook(ref LogMessageType logType);
        partial void ChangeLogTypeEdit(ref LogMessageType logType);
        partial void ChangeLogTypeAdd(ref long logType);
        partial void ChangeLogTypeLook(ref long logType);
        partial void ChangeLogTypeEdit(ref long logType);
        partial void ChangeLogContent(ref string content, MyProduct newItem, MyProduct oldItem);
        partial void ChangeLogContentAdd(ref string content, MyProduct newItem);
        partial void ChangeLogContentLook(ref string content, MyProduct item);
        partial void ChangeLogContentEdit(ref string content, MyProduct newItem, MyProduct oldItem);
        partial void InitControlPanels();
        partial void OnPreRender();
        partial void OnInsertedPartial(MyProduct newRow, bool inserted);
        partial void OnUpdatedPartial(MyProduct newRow, MyProduct originalItem, bool updated);
        partial void RemoteValidation_Name(JValue value, RemoteValidationEventArgs e);
        partial void RemoteValidation_CreationDate(JValue value, RemoteValidationEventArgs e);
        partial void RemoteValidation_Price(JValue value, RemoteValidationEventArgs e);
        partial void RemoteValidation_Amount(JValue value, RemoteValidationEventArgs e);

        #endregion

        #region Properties

        public DBDataContext DB
        {
            get
            {
                if (_db == null)
                {
                    _db = new DBDataContext(SpecificInstances.DbFactory.CreateConnection());
                }
        
                return _db;
            }
        }
        
        private List<string> AddErrorMessages
        {
            get
            {
                if (_addErrorMessages == null)
                    _addErrorMessages = source.View.AllowAddRowForTableTypes(NavigatorControl.Values, MyProductsResources.Header);
        
                return _addErrorMessages;
            }
        }
        
        [DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden)]
        [Browsable(false)]
        public ControlInfo Info
        {
            get
            {
                if (_info == null) 
                    _info = new ControlInfo(this){ DB = DB };
        
                return _info;
            }
        }
        
        protected bool RecordIsNew
        {
            get { return IsNew; }
        }
        
        protected bool RecordIsEditing
        {
            get { return SelectedValueKey != null && !IsNew && !IsRead; }
        }
        
        /// <summary>
        /// Действие логики выполняеться на начало редактирования или добавления записи, 
        /// true только однажды, при начале действий (открытии на редактирования или добавление).
        /// </summary>
        protected bool IsStartAction
        {
            get { return _isStartAction; }
        }
        
        public MyProductsJournalDataSourceView.Row SelectedRow
        {
            get
            {
                if (_selectedRow == null && !_selectedRowInited)
                {
                    if (string.IsNullOrEmpty(hfid.Text))
                        return null;
        
                    var key = Convert.ToInt64(hfid.Value);
                    _selectedRow = source.View.GetSelect(key).FirstOrDefault();
                    _selectedRowInited = true;
                }
        
                return _selectedRow;
            }
        }
        
        public MyProductsJournalDataSourceView.LookupValues SelectedLookup
        {
            get
            {
                if (ViewState["SelectedLookup"] != null)
                    return (MyProductsJournalDataSourceView.LookupValues)ViewState["SelectedLookup"];
        
                var row = SelectedRow;
                if (row == null || row.Lookup == null)
                    return null;
        
                ViewState["SelectedLookup"] = row.Lookup;
                return row.Lookup;
            }
        }
        
        private MyProduct currentRow
        {
            get 
            {
                if (_currentRow == null && SelectedRow != null)
                    _currentRow = SelectedRow.Item;
        
                return _currentRow;
            }
            set { _currentRow = value; }
        }
        
        private bool HasErrors { get; set; }
        
        private string SessionKey
        { 
            get { return string.IsNullOrEmpty(hfSessionKey.Text) ? (hfSessionKey.Text = Request.Form[hfSessionKey.UniqueID] ?? Guid.NewGuid().ToString("N")) : hfSessionKey.Text; }
            set { hfSessionKey.Text = value; }
        }
        
        public override bool IsNew
        {
            get { return SelectedValueKey == null && base.IsNew; }
        }
        
        private MyProductsActivityController ActivityController { get; set; }
        
        private bool ActivityControllerInitialized { get; set; }
        
        private bool ValidateInformationFormInitialized { get; set; }
        
        private MyProductsValidateInformationForm ValidateInformationForm { get; set; }

        [Browsable(false)]
        public long? SelectedValueKey
        {
            get 
            {
                if (!IsPostBack && !selectedValueInitialized && Url.QueryParameters.ContainsKey("refMyProducts"))
                {
                    selectedValueInitialized = true;
                    string value = Url.QueryParameters["refMyProducts"];
                    if (!string.IsNullOrEmpty(value))
                        SelectedValueKey = Convert.ToInt64(value);
                }

                if (string.IsNullOrEmpty(hfid.Text))
                    return null;

                var key = Convert.ToInt64(hfid.Value);
                return key;
            }

            private set
            {
                hfid.Value = value == null 
                    ? string.Empty
                    : value.ToString();
            }
        }

        #region ISelectedValue Members
        
        [Browsable(false)]
        public override long SelectedValueLong
        {
            get 
            { 
                throw new NotImplementedException();
            }
        }
        
        public long? ParentID { get; set; }
        public bool IsSelectParentRows { get; set; }
        
        [Browsable(false)]
        public long? SelectedValueOrParentValue
        {
            get 
            {
                return SelectedValueKey;
            }
        }
        
        [Browsable(false)]
        public override object SelectedValue
        {
            get { return SelectedValueKey; }
        }
        
        [DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden), Browsable(false)]
        public override DataKey SelectedDataKey
        {
            get 
            {
                throw new NotImplementedException();
            }
        }
        
        [DefaultValue("ID")]
        [Editor(
            "System.Web.UI.Design.WebControls.DataFieldEditor, System.Design, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"
            , typeof(UITypeEditor))]
        [TypeConverter(typeof(StringArrayConverter))]
        [Category("Data")]
        public override string[] DataKeyNames
        {
            get 
            { 
                throw new NotImplementedException();
            }
        
            set
            { 
                throw new NotImplementedException();
            }
        }
        
        public override Type TableType
        {
            get { return typeof(MyProduct); }
        }
        
        #endregion
        
        #endregion
        
        #region Methods
        
        public override void Dispose()
        {
            if (DB.Transaction != null)
                RollbackDBTransaction();
        
            DB.Dispose();
            OnDispose();
            base.Dispose();
        }
        
        protected DbTransaction BeginTransaction()
        {
            if (DB.Connection.State == ConnectionState.Closed)
                DB.Connection.Open();
            var transaction = DB.Transaction = DB.Connection.BeginTransaction();
            InitTransaction();
            return transaction;
        }
        
        protected void CommitDBTransaction()
        {
            if (DB.Transaction.Connection != null)
                DB.Transaction.Commit();
            EndTransaction();  
        }
        
        protected void RollbackDBTransaction()
        {
            if (DB.Transaction.Connection != null)
                DB.Transaction.Rollback();
            EndTransaction();  
        }
        
        protected void EndTransaction()
        {
            DB.Transaction?.Dispose();
            DB.Transaction = null;
            InitTransaction();
            
            if (DB.Connection.State == ConnectionState.Open)
                DB.Connection.Close();
        }
        
        protected void InitTransaction()
        {
            source.View.InitTransaction = DB.Transaction;
        }
        
        protected void InitConnection()
        {
            source.View.InitConnection = DB.Connection;
        }
        
        protected bool AddErrorMessage(IEnumerable<string> errors)
        {
            if (errors != null && errors.Any())
            {
                foreach (var message in errors)
                    AddErrorMessage(message);
                return true;
            }
        
            return false;
        }
        
        
        private Dictionary<Type, List<string>> GetDefaultProperties()
        {
            var properties = (Dictionary<Type, List<string>>)Cache["MyProducts_DefaultProperties"];
            if (properties == null)
            {
                properties = new Dictionary<Type, List<string>>();
        
                foreach (var property in typeof(MyProduct).GetProperties())
                {
                    var attributes = (AssociationAttribute[])property.GetCustomAttributes(typeof(AssociationAttribute), false);
                    if(attributes != null && attributes.Length == 1 && attributes[0].IsForeignKey && !"refHistory".Equals(attributes[0].ThisKey))
                    {
                        if(!properties.ContainsKey(property.PropertyType))
                            properties.Add(property.PropertyType, new List<string>());
                        properties[property.PropertyType].Add(attributes[0].ThisKey);
                    }
                }
        
                GetDefaultProperties(properties);
                Cache["MyProducts_DefaultProperties"] = properties;
            }
        
            return properties;
        }
        
        protected string GetBrowseUrl(string fieldName, object value, long? id)
        {
            var parameters = new BrowseFilterParameters();
            string selectColumnName = null;
            switch (fieldName)
            {
        
            }
        
            var jss = new JavaScriptSerializer();
            return jss.Serialize(new Triplet(parameters.ClientControlParameters, parameters.ClientValueParameters, selectColumnName));
        }
        
        protected virtual void EnsureLogicExecute()
        {
            if (SelectedValueKey == null && !IsNew)
                return;
            var executing = false;
            Trace.Write("MyProducts", "MyProductsEdit.EnsureLogicExecute.Begin");
            if (SelectedValueKey != null && IsRead && !readlogicExecuted)
            {
                readlogicExecuted = true;
                Info.IsRead = true;
                Info.ComputeReadOnlyFields(true);
                ReadLogic();
                Logic();
                executing = true;
            }
        
            if (SelectedValueKey != null && !IsNew && !IsRead && !editlogicExecuted)
            {
                editlogicExecuted = true;
                Info.IsEdit = true;
                Info.ComputeReadOnlyFields(true);
                UploadFiles();
                ExecuteEditLogic();
                EditInsertLogic();
                Logic();
                InitializeFilterParameters();
                executing = true;
            }
        
            if (IsNew && !insertlogicExecuted)
            {
                insertlogicExecuted = true;
                Info.IsInsert = true;
                if (IsStartAction)
                    SetDefaultValues();
                Info.ComputeReadOnlyFields(true);
                UploadFiles();
                ExecuteInsertLogic();
                EditInsertLogic();
                Logic();
                InitializeFilterParameters();
                executing = true;
            }
        
            if (executing)
            {
                foreach (var logic in logics)
                {
                    logic.IsEdit = SelectedValueKey != null && !IsNew && !IsRead;
                    logic.IsNew = IsNew;
                    logic.IsStartAction = IsStartAction;
                    logic.ControlInfo = Info;
                    logic.NavigatorValues = NavigatorControl.Values;
                    logic.Url = Url;
                    logic.Logic();
                }
        
                Info.ComputeReadOnlyFields(false);
                if (IsStartAction && IsNew)
                    ValidateReferences(true);
            }
        
            Trace.Write("MyProducts", "MyProductsEdit.EnsureLogicExecute.End");
        }
        
        protected virtual void ExecuteInsertLogic()
        {
            InsertLogic();
        }
        
        protected virtual void ExecuteEditLogic()
        {
            EditLogic();
        }
        
        private void InitializeFilterParameters()
        {
            BrowseFilterParameters parameters;
        }
        
        /// <summary>
        /// Проверка ссылок на валидность.
        /// </summary>
        /// <param name="isDefault">Флаг о том что заполнены поля по умолчанию.</param>
        private bool ValidateReferences(bool isDefault)
        {
            var isValid = true;
            Trace.Write("MyProducts", "MyProductsEdit.ValidateReferences.Begin");
        
            Trace.Write("MyProducts", "MyProductsEdit.ValidateReferences.End");
            return isValid;
        }

        protected IFilterControl GetFilterControl(DBDataContext db)
        {
            var filterControlInternal = new MyProductsFilter { Page = Page };
            filterControlInternal.SetUrl(Url);
            filterControlInternal.SetDB(db);
            filterControlInternal.SelectedID = SelectedValueKey;
            filterControlInternal.ShowHistory = true;
            return filterControlInternal;
        }

        
        
        /// <summary>
        /// Сохранение формы.
        /// </summary>
        /// <param name="sender">Объект вызвавший событие.</param>
        /// <param name="e">Параметры события.</param>
        protected void SaveData(object sender, DirectEventArgs e)
        {
            MyProduct originalItem = null;
        
            using (var db = new DBDataContext(DB.Connection ?? SpecificInstances.DbFactory.CreateConnection()))
            {
                // Если запись редактируется, то получаем строку из базы и проверяем версии записи
                if (!IsNew)
                {
                    source.View.DB.Dispose();
                    source.View.DB = db;
                    var row = source.View.GetSelect(SelectedValueKey.Value)
                        .Select(r => new { r.Item, r.CanEdit })
                        .FirstOrDefault();
                    if (row == null)
                    {
                        AddErrorMessage(Nat.Web.Controls.Properties.Resources.ERowIsDeletedOrNotHavePermissions);
                        source.View.DB = null;
                        return;
                    }
                    else if (!row.CanEdit)
                    {
                        AddErrorMessage(Nat.Web.Controls.Properties.Resources.EDoesNotHavePermitForEdit);
                        source.View.DB = null;
                        return;
                    }
        
                    originalItem = row.Item;
                    source.View.DB = new DBDataContext(DB.Connection ?? SpecificInstances.DbFactory.CreateConnection());
                    if (originalItem == null)
                    {
                        AddErrorMessage(Nat.Web.Controls.Properties.Resources.ERowIsDeletedOrNotHavePermissions);
                        return;
                    }
                    
                    var rowVersion = Convert.ToBase64String(originalItem.RowVersion.ToArray());
                    if (rowVersion != rowVersionHiddenField.Text)
                    {
                        // todo: подумать о реализации конкурентных изменений
                        AddErrorMessage(Nat.Web.Controls.Properties.Resources.ERecordModifiedByOther);
                        return;
                    }
                }
        
                if (SaveData(originalItem))
                {
                    if (!IsNew && Url.QueryParameters.ContainsKey("MultipleEdit"))
                    {
                        var keys = Url.QueryParameters["MultipleEdit"].Split(new[] {','}, StringSplitOptions.RemoveEmptyEntries).Select(r => Convert.ToInt64(r)).ToArray();
                        var data = source.View.GetSelect().Where(r => keys.Contains(r.id)).Where(r => r.CanEdit);
                        foreach(var otherRow in data)
                            SaveData(otherRow.Item);
                    }
        
                    IsNew = false;
                    IsRead = false;
                    Info.IsEdit = true;
                    editlogicExecuted = false;
                    insertlogicExecuted = false;
                    readlogicExecuted = false;
                    source.View.DB.Dispose();
                    source.View.DB = new DBDataContext(DB.Connection ?? SpecificInstances.DbFactory.CreateConnection());
                    UpdateForm(true);
        
                    ResourceManager.AddInstanceScript(
                        string.Format(
                            "if (window.frameElement != null && window.frameElement.CloseOnSaveSuccessfull != null)\r\n" +
                            "    window.frameElement.CloseOnSaveSuccessfull({0});",
                            SelectedValueKey));
                }
            }
        }
        
        protected bool SaveData(MyProduct originalItem)
        {
            // Выполняем логику формы
            EnsureLogicExecute();
        
            // Валидируем
            var valid = ValidateInfo();
            var newItem = GetNewItem(originalItem);
            valid = valid & ValidateReferences(false);
            if (!valid) return false;
        
            // Добавляем запись в модель на обновление или добавление
            if (IsNew)
            {
                if (!AccessOptions.CheckPermitAdd())
                {
                    AddErrorMessage(Nat.Web.Controls.Properties.Resources.EDoesNotHavePermitForAdd);
                    return false;
                }
        
                DB.MyProducts.InsertOnSubmit(newItem);
                OnInserting(newItem);
                Inserting(newItem);
            }
            else
            {
                DB.MyProducts.Attach(newItem, originalItem);
                OnUpdating(newItem, originalItem);
                Updating(originalItem, newItem);
            }
        
            // todo: разрулить Exception на базе
            // Обновляем в БД
            try
            {
                DB.SubmitChanges();
        
                // Вызываем события о том что обновленно
                if (IsNew)
                {
                    OnInserted(true, newItem);
                    OnInsertedPartial(newItem, true);
                }
                else
                {
                    OnUpdated(true, newItem);
                    OnUpdatedPartial(newItem, originalItem, true);
                }
        
                SelectedValueKey = refMyProducts;
                return true;
            }
            catch (SqlException ex)
            {
                if (ex.Errors[0].Number > 50000)
                    AddErrorMessage(ex.Errors[0].Message);
                else
                    X.Msg.Alert("Exception", ex.ToString()).Show();
                return false;
            }
            catch(Exception ex)
            {
                X.Msg.Alert("Exception", ex.ToString()).Show();
                return false;
            }
        }
        
        /// <summary>
        /// Получение новой строки для вставки или обновления.
        /// </summary>
        /// <param name="originalValues">Строка с оригинальными значениями.</param>
        protected MyProduct GetNewItem(MyProduct originalValues)
        {
            MyProduct newItem;
        
            // Создание нового элемента
            if (originalValues == null)
                newItem = new MyProduct();
            else
            {
                // Создание нового элемента и копирование из оригинала значений полей
                newItem = new MyProduct
                    {
                        id = originalValues.id,
                        Amount = originalValues.Amount,
                        RowVersion = originalValues.RowVersion,
                    };
            }
        
            // Получение значений полей из Info
            if (!string.IsNullOrEmpty(Info.Name))
                newItem.Name = Info.Name;
            else
                newItem.Name = null;
            if (Info.CreationDate != null)
                newItem.CreationDate = (DateTime)Info.CreationDate;
            else
                newItem.CreationDate = default(DateTime);
            if (Info.Price != null)
                newItem.Price = (Decimal)Info.Price;
            else
                newItem.Price = default(Decimal);
        
            return newItem;
        }
        
        /// <summary>
        /// Проверка данных на валидность.
        /// </summary>
        protected bool ValidateInfo()
        {
            EnsureActivityControllerInitialized();
            ActivityController.ComputeActivities();
            EnsureValidateInformationFormInitialized();
        
            var valid = ValidateInformationForm.Validate();
            valid = valid & ValidateField_Name();
            valid = valid & ValidateField_CreationDate();
            valid = valid & ValidateField_Price();
            valid = valid & ValidateField_Amount();
        
            return valid;
        }
        
        partial void ValidateField_Name(ref bool valid);
        
        private bool ValidateField_Name()
        {
            var valid = true;
            if (ActivityController.NameControl.AllowRequiredValidate || ValidateInformationForm.IsRequired("Name"))
                valid = !string.IsNullOrEmpty(Info.Name);
        
            if (!valid)
            {
                AddErrorMessage(GetRequiredMessage_Name());
                return false;
            }
        
            if (ActivityController.NameControl.AllowValidate)
                ValidateField_Name(ref valid);
        
            return valid;
        }
        
        partial void ValidateField_CreationDate(ref bool valid);
        
        private bool ValidateField_CreationDate()
        {
            var valid = true;
            if (ActivityController.CreationDateControl.AllowRequiredValidate || ValidateInformationForm.IsRequired("CreationDate"))
                valid = Info.CreationDate != null;
        
            if (!valid)
            {
                AddErrorMessage(GetRequiredMessage_CreationDate());
                return false;
            }
        
            if (ActivityController.CreationDateControl.AllowValidate)
                ValidateField_CreationDate(ref valid);
        
            return valid;
        }
        
        partial void ValidateField_Price(ref bool valid);
        
        private bool ValidateField_Price()
        {
            var valid = true;
            if (ActivityController.PriceControl.AllowRequiredValidate || ValidateInformationForm.IsRequired("Price"))
                valid = Info.Price != null;
        
            if (!valid)
            {
                AddErrorMessage(GetRequiredMessage_Price());
                return false;
            }
        
            if (ActivityController.PriceControl.AllowValidate)
                ValidateField_Price(ref valid);
        
            return valid;
        }
        
        partial void ValidateField_Amount(ref bool valid);
        
        private bool ValidateField_Amount()
        {
            var valid = true;
            if (ActivityController.AmountControl.AllowRequiredValidate || ValidateInformationForm.IsRequired("Amount"))
                valid = Info.Amount != null;
        
            if (!valid)
            {
                AddErrorMessage(GetRequiredMessage_Amount());
                return false;
            }
        
            if (ActivityController.AmountControl.AllowValidate)
                ValidateField_Amount(ref valid);
        
            return valid;
        }
        
        private void UpdateForm(bool loadRow)
        {
            if (!IsPostBack)
                loadRow = true;
        
            if (IsRead)
                Info.IsRead = true;
        
            if (!IsNew && loadRow)
            {
                var row = SelectedValueKey == null ? null : source.View.GetSelect(SelectedValueKey.Value).FirstOrDefault();
                if (row == null)
                {
                    if (SelectedValueKey != null)
                        AddErrorMessage(Nat.Web.Controls.Properties.Resources.ERowIsDeletedOrNotHavePermissions);
                    SelectedValueKey = null;
                    IsRead = true;
                    Info.IsRead = true;
                    FormPanelMyProducts.Hidden = true;
                    return;
                }
        
                if (!AccessOptions.CheckPermitEdit())
                {
                    if (!IsRead)
                        AddErrorMessage(Nat.Web.Controls.Properties.Resources.EDoesNotHavePermitForEdit);
                    IsRead = true;
                    Info.IsRead = true;
                }
                else if (!row.CanEdit)
                {
                    if (!IsRead)
                    {
                        var messages = source.View.GetEditErrors(SelectedValueKey.Value, MyProductsResources.Header);
                        if (messages.All(string.IsNullOrEmpty))
                            AddErrorMessage(Nat.Web.Controls.Properties.Resources.EDoesNotHavePermitForEdit);
                        else
                            AddErrorMessage(messages.Where(r => !string.IsNullOrEmpty(r)));
                    }
        
                    IsRead = true;
                    Info.IsRead = true;
                }
        
                rowVersionHiddenField.Text = Convert.ToBase64String(row.Item.RowVersion.ToArray());
                object data;
        
                FormPanelMyProducts.SetValues(
                    new 
                        {
                            row.Item.Name,
                            row.Item.CreationDate,
                            row.Item.Price,
                            row.Item.Amount,
                        });
                UpdateForm(row.Item);
                FormPanelMyProducts.DataBind();
            }
            else if (IsNew && !AccessOptions.CheckPermitAdd())
            {
                AddErrorMessage(Nat.Web.Controls.Properties.Resources.EDoesNotHavePermitForAdd);
                IsNew = false;
                IsRead = true;
                Info.IsRead = true;
                UpdateFormToNull();
            }
            else if (IsNew && loadRow)
            {
                var messages = source.View.AllowAddRowForTableTypes(NavigatorControl.Values, MyProductsResources.Header).ToList();
                if (messages.Any(r => !string.IsNullOrEmpty(r)))
                {
                    foreach(var message in messages.Where(r => !string.IsNullOrEmpty(r)))
                        AddErrorMessage(message);
                    IsNew = false;
                    IsRead = true;
                    Info.IsRead = true;
                    UpdateFormToNull();
                }
                else if (messages.Any(string.IsNullOrEmpty))
                {
                    AddErrorMessage(Nat.Web.Controls.Properties.Resources.EDoesNotHavePermitForAdd);
                    IsNew = false;
                    IsRead = true;
                    Info.IsRead = true;
                    UpdateFormToNull();
                }
                else
                {
                    rowVersionHiddenField.Text = string.Empty;
                    FormPanelMyProducts.SetValues(null);
                    UpdateFormToNull();
                    FormPanelMyProducts.DataBind();
                }
            }
        }
        
        private void UpdateForm(MyProduct row)
        {
            Info.Name = row.Name;
            Info.CreationDate = row.CreationDate;
            Info.Price = row.Price;
            Info.Amount = row.Amount;
        }
        
        private void UpdateFormToNull()
        {
            Info.Name = null;
            Info.CreationDate = null;
            Info.Price = null;
            Info.Amount = null;
        }
        
        private void GenerateHtmlAdditionalButtonsInternal()
        {
            var toolbar = FormPanelMyProducts.BottomBar.First();
            Action<AbstractComponent> addButton = commponent => toolbar.Items.Add(commponent);
            Action<AbstractComponent, AbstractComponent> insertAfterButton = (commponent, after) => toolbar.Items.Insert(toolbar.Items.IndexOf(after) + 1, commponent);
            var buttons = new AdditionalButtons(addButton, insertAfterButton);
            GenerateAdditionalButtons(buttons);
        }
        
        private void InitComboBoxViews()
        {
        }
        
        protected override IWorkFlow[] CreateWorkFlows()
        {
            return new IWorkFlow[] {};
        }
        
        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);
            InitConnection();
            GenerateHtmlAdditionalButtonsInternal();
            InitControlPanels();
            InitComboBoxViews();
        }
        
        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);
        
            if (!IsPostBack || IsFirstCreation)
                _isStartAction = true;
        
            UpdateForm(false);
        }
        
        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);
        
            EnsureLogicExecute();
            EnsureActivityControllerInitialized();
            ActivityController.ComputeActivities();
            EnsureValidateInformationFormInitialized();
        
            if (!DesignMode)
                ScriptManager.GetCurrent(Page).RegisterScriptControl(this);
        
            if ((IsNew && AccessOptions.CheckPermitAdd()) || (!IsRead && AccessOptions.CheckPermitEdit()))
            {
                SaveButton.Show();
                SaveButton.Hidden = false;
            }
            else
            {
                SaveButton.Hide();
                SaveButton.Hidden = true;
            }
            OnPreRender();
        }
        
        protected override void Render(HtmlTextWriter writer)
        {
            base.Render(writer);
            if (!DesignMode)
                ScriptManager.GetCurrent(Page).RegisterScriptDescriptors(this);
        }
        
        IEnumerable<ScriptDescriptor> IScriptControl.GetScriptDescriptors()
        {
            if (FormPanelMyProducts.Hidden)
                return new ScriptDescriptor[0];
            return ((IScriptControl)ActivityController).GetScriptDescriptors();
        }
        
        IEnumerable<ScriptReference> IScriptControl.GetScriptReferences()
        {
            return ((IScriptControl)ActivityController).GetScriptReferences();
        }
        
        
        private void SetDefaultValues()
        {
            _setDefaultValues = true;
        }
        
        
        
        public void EnsureInitedDefaultValue(Type type)
        {
            if (!IsStartAction || _setDefaultValues || _isNoPermit || !IsNew) return;
        }
        
        private void SetDefaultValues(MyProduct item)
        {
            var properties = GetDefaultProperties();
        }
        
        protected void EnsureActivityControllerInitialized()
        {
            if (ActivityControllerInitialized)
                return;
            ActivityControllerInitialized = true;
            ActivityController = new MyProductsActivityController();
            var dic = GetValuesForActivityController();
            ActivityController.Initialize(this, dic, Info);
        }
        
        private Dictionary<string, object> GetValuesForActivityController()
        {
            var dic = new Dictionary<string, object>();
            dic["Name"] = Info.Name;
            dic["CreationDate"] = Info.CreationDate;
            dic["Price"] = Info.Price;
            dic["Amount"] = Info.Amount;
        
            return dic;
        }
        
        protected void EnsureValidateInformationFormInitialized()
        {
            if (ValidateInformationFormInitialized)
                return;
        
            ValidateInformationFormInitialized = true;
            ValidateInformationForm = 
                new MyProductsValidateInformationForm(FormPanelMyProducts)
                    {
                        ValidationGroup = "MyProducts",
                    };
        
        
            GetValidators_Name(ValidateInformationForm.Name);
            ValidateInformationForm.AddDefaultValidatorsForName(Info);
            ValidateInformationForm.ApplyValidators(
                new ValidateInformationFormApplyArgsInfo
                    {
                        ValidatorCode = "Name",
                        Control = Info.NameControl,
                        ReadOnly = ActivityController.NameControl.ReadOnly,
                        ValidationContainer = "phName",
                    });
        
            GetValidators_CreationDate(ValidateInformationForm.CreationDate);
            ValidateInformationForm.AddDefaultValidatorsForCreationDate(Info);
            ValidateInformationForm.ApplyValidators(
                new ValidateInformationFormApplyArgsInfo
                    {
                        ValidatorCode = "CreationDate",
                        Control = Info.CreationDateControl,
                        ReadOnly = ActivityController.CreationDateControl.ReadOnly,
                        ValidationContainer = "phCreationDate",
                    });
        
            GetValidators_Price(ValidateInformationForm.Price);
            ValidateInformationForm.AddDefaultValidatorsForPrice(Info);
            ValidateInformationForm.ApplyValidators(
                new ValidateInformationFormApplyArgsInfo
                    {
                        ValidatorCode = "Price",
                        Control = Info.PriceControl,
                        ReadOnly = ActivityController.PriceControl.ReadOnly,
                        ValidationContainer = "phPrice",
                    });
        
            GetValidators_Amount(ValidateInformationForm.Amount);
            ValidateInformationForm.AddDefaultValidatorsForAmount(Info);
            ValidateInformationForm.ApplyValidators(
                new ValidateInformationFormApplyArgsInfo
                    {
                        ValidatorCode = "Amount",
                        Control = Info.AmountControl,
                        ReadOnly = true,
                        ValidationContainer = "phAmount",
                    });
        }
        
        private void SetReadOnlyValues(MyProduct item)
        {
        }
        
        private void SetOtherValues(MyProduct item)
        {
        }
        
        private void SetMultipleKeyValues(MyProduct item)
        {
        }
        
        private void UploadFilesUpdateItem(MyProduct item)
        {
        }
        
        private void UploadFiles()
        {
        }

        public void RemoteValidationFields(object sender, RemoteValidationEventArgs e)
        {
            var value = (JValue)e.Value;
            e.Success = true;
            switch (e.Name)
            {
                case "Name":
                    RemoteValidation_Name(value, e);
                    break;
                case "CreationDate":
                    RemoteValidation_CreationDate(value, e);
                    break;
                case "Price":
                    RemoteValidation_Price(value, e);
                    break;
                case "Amount":
                    RemoteValidation_Amount(value, e);
                    break;
            }
        }

        #endregion
        
        #region Events
        
        protected void lds_Inserted(object sender, LinqDataSourceStatusEventArgs e)
        {
            var row = e.Result as MyProduct;
            OnInserted(row != null, row);
            OnInserted(e);
        
            if (row != null && !HasErrors)
            {
                if (DB.Transaction != null)
                    CommitDBTransaction();
            }
        }
        
        protected void lds_Updated(object sender, LinqDataSourceStatusEventArgs e)
        {
            var row = e.Result as MyProduct;
            var hasRow = row != null;
            OnUpdated(hasRow, row);
            OnUpdated(e);
        
            if (row != null && !HasErrors)
            {
                if (DB.Transaction != null)
                    CommitDBTransaction();
            }
        }
        
        protected void OnInserted(bool inserted, MyProduct row)
        {
            if (inserted)
            {
               refMyProducts = row.id;
            }
        
            foreach (var logic in logics)
            {
                var errors = logic.AfterSave(inserted, row);
                if (errors != null && errors.Count > 0)
                {
                    foreach(var message in errors)
                        AddErrorMessage(message);
                    break;
                }
            }
        
                #region InsertChildCollections
            if (row != null)
            {
                
            }
            #endregion
        
            if (row != null)
            {
                foreach (var wf in WorkFlows)
                {
                    wf.DataContext = DB;
                    wf.BaseControlInfo = Info;
                    wf.JournalControl = this;
                    wf.OnInserted(row);
                }
            }
        }
        
        protected void OnUpdated(bool updated, MyProduct row)
        {
            if (updated)
            {
                refMyProducts = row.id;
                UpdateRefMyProducts(row);
            }
        
            foreach (var logic in logics)
            {
                var errors = logic.AfterSave(updated, row);
                if (errors != null && errors.Count > 0)
                {
                    foreach(var message in errors)
                        AddErrorMessage(message);
                    break;
                }
            }
        
            #region UpdateChildCollections
            if (row != null)
            {
                
            }
            #endregion
        
            if (row != null)
            {
                foreach (var wf in WorkFlows)
                {
                    wf.DataContext = DB;
                    wf.BaseControlInfo = Info;
                    wf.JournalControl = this;
                    wf.OnUpdated(row, refMyProducts.ToString());
                }
            }
        }
        
        protected void ldsChanges_Selecting(object sender, LinqDataSourceSelectEventArgs e)
        {
        }
        
        protected void lds_Selecting(object sender, LinqDataSourceSelectEventArgs e)
        {
        }
        
        protected void lds_Updating(object sender, LinqDataSourceUpdateEventArgs e)
        {
            if (e.Exception != null)
            {
                AddErrorMessage(e.Exception.Message);
                LogMonitor.LogException(e.Exception);
                e.ExceptionHandled = true;
                return;
            }
        
            SetReadOnlyValues((MyProduct)e.NewObject);
            SetMultipleKeyValues((MyProduct)e.NewObject);
            SetOtherValues((MyProduct)e.NewObject);
            e.Cancel = !Updating((MyProduct)e.OriginalObject, (MyProduct)e.NewObject);
        }
        
        protected void ldsChanges_Updating(object sender, LinqDataSourceUpdateEventArgs e)
        {
            if (e.Exception != null)
            {
                AddErrorMessage(e.Exception.Message);
                LogMonitor.LogException(e.Exception);
                e.ExceptionHandled = true;
                return;
            }
        
            SetReadOnlyValues((MyProduct)e.NewObject);
            SetMultipleKeyValues((MyProduct)e.NewObject);
            SetOtherValues((MyProduct)e.NewObject);
            e.Cancel = !Updating((MyProduct)e.OriginalObject, (MyProduct)e.NewObject);
        }
        
        protected void lds_Inserting(object sender, LinqDataSourceInsertEventArgs e)
        {
            if (e.Exception != null)
            {
                AddErrorMessage(e.Exception.Message);
                LogMonitor.LogException(e.Exception);
                e.ExceptionHandled = true;
                return;
            }
        
            SetReadOnlyValues((MyProduct)e.NewObject);
            SetMultipleKeyValues((MyProduct)e.NewObject);
            SetOtherValues((MyProduct)e.NewObject);
            e.Cancel = !Inserting((MyProduct) e.NewObject);
        }
        
        protected void ldsChanges_Inserting(object sender, LinqDataSourceInsertEventArgs e)
        {
            if (e.Exception != null)
            {
                AddErrorMessage(e.Exception.Message);
                LogMonitor.LogException(e.Exception);
                e.ExceptionHandled = true;
                return;
            }
        
            SetReadOnlyValues((MyProduct)e.NewObject);
            SetMultipleKeyValues((MyProduct)e.NewObject);
            SetOtherValues((MyProduct)e.NewObject);
            e.Cancel = !Inserting((MyProduct) e.NewObject);
        }
        
        protected void Source_Selecting(object sender, DataSourceSelectingEventArgs e)
        {
            e.FilterControl = GetFilterControl((DBDataContext)e.DB);
        }
        
        protected void lds_ContextCreating(object sender, LinqDataSourceContextEventArgs e)
        {
            OnContextCreating(e);
            e.ObjectInstance = DB;
        }
        
        protected void lds_ContextDisposing(object sender, LinqDataSourceDisposeEventArgs e)
        {
            if (_db != null && _db.Transaction != null)
                RollbackDBTransaction();
            _db = null;
            var d = (IDisposable)e.ObjectInstance;
            d.Dispose();
        }
        
        #endregion

        #region Permission
        
        bool IAccessControl.CheckPermit(Page page)
        {
            return AccessOptions.CheckPermit();
        }
        
        #endregion

        #region Log
        
        private LogMonitor _logMonitor;
        protected LogMonitor LogMonitor
        {
            get
            {
                if(_logMonitor == null)
                {
                    _logMonitor = new LogMonitor();
                    _logMonitor.Init();
                }
                return _logMonitor;
            }
        }

        protected bool Inserting(MyProduct newRow)
        {
        
            return true;
        }

        protected bool Updating(MyProduct originalRow, MyProduct newRow)
        {
        
            return true;
        }
        
        #endregion

        #region EMailMessages

            

        #endregion
        
        #region Methods for help to show messages

        public static string GetRequiredMessage(string group, string header)
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SRequiredFieldMessage, GenerationHelper.GetHeaderName(group, header));
        }
        /// <summary>
        /// Сообщение об обязательности поля 'Наименование'.
        /// </summary>
        public static string GetRequiredMessage_Name()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SRequiredFieldMessage, GenerationHelper.GetHeaderName(MyProductsResources.Name__Group, MyProductsResources.Name__Header));
        }
        
        /// <summary>
        /// Сообщение об обязательности поля 'Дата создания'.
        /// </summary>
        public static string GetRequiredMessage_CreationDate()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SRequiredFieldMessage, GenerationHelper.GetHeaderName(MyProductsResources.CreationDate__Group, MyProductsResources.CreationDate__Header));
        }
        
        /// <summary>
        /// Сообщение об обязательности поля 'Цена'.
        /// </summary>
        public static string GetRequiredMessage_Price()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SRequiredFieldMessage, GenerationHelper.GetHeaderName(MyProductsResources.Price__Group, MyProductsResources.Price__Header));
        }
        
        /// <summary>
        /// Сообщение об обязательности поля 'Доступно'.
        /// </summary>
        public static string GetRequiredMessage_Amount()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SRequiredFieldMessage, GenerationHelper.GetHeaderName(MyProductsResources.Amount__Group, MyProductsResources.Amount__Header));
        }
        
        public static string GetMaxLengthMessage(int length)
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SMaxLength, length);
        }
        /// <summary>
        /// Сообщение о максимальной длине 200 поля 'Наименование'.
        /// </summary>
        public static string GetMaxLengthOfField_Name()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SMaxLengthOfField, GenerationHelper.GetHeaderName(MyProductsResources.Name__Group, MyProductsResources.Name__Header), 200);
        }
        
        /// <summary>
        /// Сообщение о максимальной длине 7 поля 'Цена'.
        /// </summary>
        public static string GetMaxLengthOfField_Price()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SMaxLengthOfField, GenerationHelper.GetHeaderName(MyProductsResources.Price__Group, MyProductsResources.Price__Header), 7);
        }
        
        /// <summary>
        /// Сообщение о максимальной длине 7 поля 'Доступно'.
        /// </summary>
        public static string GetMaxLengthOfField_Amount()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SMaxLengthOfField, GenerationHelper.GetHeaderName(MyProductsResources.Amount__Group, MyProductsResources.Amount__Header), 7);
        }
        
        /// <summary>
        /// Сообщение о не корректном вводе числового значения в поле 'Цена'.
        /// </summary>
        public static string GetNotCorrectNumberMessage_Price()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SNotCorrectNumberOfField, GenerationHelper.GetHeaderName(MyProductsResources.Price__Group, MyProductsResources.Price__Header));
        }
        
        /// <summary>
        /// Сообщение о не корректном вводе числового значения в поле 'Доступно'.
        /// </summary>
        public static string GetNotCorrectNumberMessage_Amount()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SNotCorrectNumberOfField, GenerationHelper.GetHeaderName(MyProductsResources.Amount__Group, MyProductsResources.Amount__Header));
        }
        
        /// <summary>
        /// Заголовок колнки 'Наименование'. Берется из ресурсов с учетов группы.
        /// </summary>
        public static string GetHeaderOfColumn_Name()
        {
            return GenerationHelper.GetHeaderName(MyProductsResources.Name__Group, MyProductsResources.Name__Header);
        }
        
        /// <summary>
        /// Заголовок колнки 'Дата создания'. Берется из ресурсов с учетов группы.
        /// </summary>
        public static string GetHeaderOfColumn_CreationDate()
        {
            return GenerationHelper.GetHeaderName(MyProductsResources.CreationDate__Group, MyProductsResources.CreationDate__Header);
        }
        
        /// <summary>
        /// Заголовок колнки 'Цена'. Берется из ресурсов с учетов группы.
        /// </summary>
        public static string GetHeaderOfColumn_Price()
        {
            return GenerationHelper.GetHeaderName(MyProductsResources.Price__Group, MyProductsResources.Price__Header);
        }
        
        /// <summary>
        /// Заголовок колнки 'Доступно'. Берется из ресурсов с учетов группы.
        /// </summary>
        public static string GetHeaderOfColumn_Amount()
        {
            return GenerationHelper.GetHeaderName(MyProductsResources.Amount__Group, MyProductsResources.Amount__Header);
        }
        
        #endregion

        #region Nested type: ControlInfo

        public partial class ControlInfo : BaseControlInfo
        {
            private Dictionary<string, object> savedValues;
            private MyProductsEdit edit;
            private TextBox _NameControl;
            public const int NameLength = 200;
            
            private DatePicker _CreationDateControl;
            
            
            private NullableTextBox _PriceControl;
            public const int PriceLength = 7;
            public const int PricePrecision = 2;
            
            private NullableTextBox _AmountControl;
            public const int AmountLength = 7;
            public const int AmountPrecision = 2;
            
            private bool isWireToChangesEvents;
            private bool isWireToEditFieldEvents;
            private DBDataContext _db;

            public DBDataContext DB
            {
                get
                {
                    if (_db == null)
                    {
                        _db = new DBDataContext(SpecificInstances.DbFactory.CreateConnection());
                    }

                    return _db;
                }
                set
                {
                    _db = value;
                }
            }

            public ControlInfo(MyProductsEdit edit)
                : base (edit.FormPanelMyProducts)
            {
                this.edit = edit;
                GetSelectedValue = () => edit.SelectedValueKey.ToString();
            }


            /// <summary>
            /// Наименование.
            /// </summary>
            public String Name
            {
                get
                {
                    if (NameControl.IsEmpty)
                        return null;
                    var value = NameControl.Text;
            
                    return Convert.ToString(value);
                }
                set
                {
                    NameControl.SetValue(value);
                }
            }

            /// <summary>
            /// Контрол поля "Наименование".
            /// </summary>
            public TextBox NameControl
            {
                get
                {
                    if (_NameControl == null)
                        _NameControl = (TextBox)FindControl("tbName");
                    return _NameControl;
                }
            }

            /// <summary>
            /// Флаг об изменении пользователем значения поля "Наименование", за последний раз.
            /// </summary>
            public bool IsNameChanged { get; set; }

            /// <summary>
            /// Дата создания.
            /// </summary>
            public DateTime? CreationDate
            {
                get
                {
                    if (CreationDateControl.IsEmpty)
                        return null;
                    var value = CreationDateControl.RawValue;
            
                    return Convert.ToDateTime(value);
                }
                set
                {
                    CreationDateControl.RawValue = string.Format("{0:d}", value);CreationDateControl.SetValue(value);
                }
            }

            /// <summary>
            /// Контрол поля "Дата создания".
            /// </summary>
            public DatePicker CreationDateControl
            {
                get
                {
                    if (_CreationDateControl == null)
                        _CreationDateControl = (DatePicker)FindControl("dpCreationDate");
                    return _CreationDateControl;
                }
            }

            /// <summary>
            /// Флаг об изменении пользователем значения поля "Дата создания", за последний раз.
            /// </summary>
            public bool IsCreationDateChanged { get; set; }

            /// <summary>
            /// Цена.
            /// </summary>
            public Decimal? Price
            {
                get
                {
                    if (PriceControl.IsEmpty)
                        return null;
                    var value = PriceControl.Number;
            
                    return Convert.ToDecimal(value);
                }
                set
                {
                    PriceControl.SetValue(value);
                }
            }

            /// <summary>
            /// Контрол поля "Цена".
            /// </summary>
            public NullableTextBox PriceControl
            {
                get
                {
                    if (_PriceControl == null)
                        _PriceControl = (NullableTextBox)FindControl("tbPrice");
                    return _PriceControl;
                }
            }

            /// <summary>
            /// Флаг об изменении пользователем значения поля "Цена", за последний раз.
            /// </summary>
            public bool IsPriceChanged { get; set; }

            /// <summary>
            /// Доступно.
            /// </summary>
            public Decimal? Amount
            {
                get
                {
                    if (AmountControl.IsEmpty)
                        return null;
                    var value = AmountControl.Number;
            
                    return Convert.ToDecimal(value);
                }
                set
                {
                    AmountControl.SetValue(value);
                }
            }

            /// <summary>
            /// Контрол поля "Доступно".
            /// </summary>
            public NullableTextBox AmountControl
            {
                get
                {
                    if (_AmountControl == null)
                        _AmountControl = (NullableTextBox)FindControl("tbAmount");
                    return _AmountControl;
                }
            }

            /// <summary>
            /// Флаг об изменении пользователем значения поля "Доступно", за последний раз.
            /// </summary>
            public bool IsAmountChanged { get; set; }

            public override void WireToChangesEvent()
            {
                if (edit.SelectedValueKey != null && edit.IsRead || isWireToChangesEvents || (edit.SelectedValueKey != null && !edit.IsNew && !edit.IsRead && string.IsNullOrEmpty(SelectedValue)))
                    return;

                isWireToChangesEvents = true;
                NameControl.TextChanged += delegate { IsNameChanged = true; };
                CreationDateControl.TextChanged += delegate { IsCreationDateChanged = true; };
                PriceControl.TextChanged += delegate { IsPriceChanged = true; };
                
            }

            public override void WireToEditFieldEvents()
            {
                if (isWireToEditFieldEvents || (!(edit.IsNew) && string.IsNullOrEmpty(SelectedValue))) 
                    return;

                isWireToEditFieldEvents = true;
            }

            public override void ClearRefToControls()
            {
                _NameControl = null;
                _CreationDateControl = null;
                _PriceControl = null;
                _AmountControl = null;
                isWireToChangesEvents = false;
                isWireToEditFieldEvents = false;
            }

            public override bool HasSavedValues
            {
                get { return savedValues != null; }
            }

            public override void SaveValues()
            {
                if (savedValues == null)
                    savedValues = new Dictionary<string, object>();
                else
                    savedValues.Clear();

                savedValues.Add("Name", NameControl.Text);
                savedValues.Add("CreationDate", CreationDateControl.SelectedValue);
                savedValues.Add("Price", PriceControl.Text);
                savedValues.Add("Amount", Amount);
            }

            public override void LoadValues()
            {
                if (savedValues == null)
                    throw new NullReferenceException("Before execute LoadValues need execute SaveValues");

                NameControl.Text = (string)savedValues["Name"];
                CreationDateControl.SelectedValue = savedValues["CreationDate"];
                PriceControl.Text = (string)savedValues["Price"];
                Amount = (Decimal)savedValues["Amount"];
            }

            public override void SetValue(string property, object value, string text, string alternativeText)
            {
                switch (property)
                {                    default:
                        throw new Exception(string.Format("property '{0}' not exist in table 'MyProducts'", property));
                }
            }

/*
            private IList<WebControl> _controls;
            public IList<WebControl> Controls
            {
                get
                {
                    if (_controls == null)
                    {
                        _controls = new List<WebControl>
                                        {
                                            NameControl,
                                            CreationDateControl,
                                            PriceControl,
                                            AmountControl,
                                        };
                    }
                    return _controls;
                }
            }*/
        }

        public partial class RecordEvents : BaseRecordEvents<long, MyProduct>
        {
            private DBDataContext _db;
        
            protected DBDataContext DB
            {
                get
                {
                    if (_db == null)
                    {
                        _db = new DBDataContext(SpecificInstances.DbFactory.CreateConnection());
                    }
        
                    return _db;
                }
            }
        
            public long? MyProducts
            {
                get
                {
                    if (!Values.ContainsKey(typeof(MyProduct))) return null;
                    return (long?)Values[typeof(MyProduct)];
                }
                set
                {
                    Values[typeof(MyProduct)] = value;
                }
            }
        
            /// <summary>
            /// Не трогать!!! :)
            /// </summary>
            public MyProductsJournalDataSourceView.Row SelectedRow { get; set; }
        }

        #endregion
    }
}