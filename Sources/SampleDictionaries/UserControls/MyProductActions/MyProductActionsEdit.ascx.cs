/*
 * Generated by: Sergey.Shpakovskiy
 * Generated at: 1.0.0.2
 * Copyright © JSC NAT Kazakhstan 2011
 */
#pragma warning disable

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Data.Common;
using System.Data.Linq;
using System.Data.Linq.Mapping;
using System.Data.SqlClient;
using System.Drawing.Design;
using System.Globalization;
using System.Linq;
using System.Security.Principal;
using System.Text;
using System.Xml.Linq;
using System.Web;
using System.Web.Compilation;
using System.Web.Script.Serialization;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.IO;
using System.Net.Mail;
using System.Net;
using System.Collections.Specialized;
using System.Web.Configuration;
using SampleDictionaries.Properties;


using Nat.Tools.Specific;
using Nat.Web.Controls;
using Nat.Web.Controls.BaseLogic;
using Nat.Web.Controls.Data;
using Nat.Web.Controls.DateTimeControls;
using Nat.Web.Controls.GenerationClasses;
using Nat.Web.Controls.GenerationClasses.Data;
using Nat.Web.Controls.GenerationClasses.Navigator;
using Nat.Web.Controls.HistoryFilters;
using Nat.Web.Controls.Preview;
using Nat.Web.Controls.SelectValues;
using Nat.Web.Tools;
using Nat.Web.Tools.Security;
using Nat.Web.Tools.WorkFlow;
using AccessOptions = SampleDictionaries.MyProductActionsAccessOptions;
using TableResources = SampleDictionaries.Properties.TableResources;
using SampleDictionaries;
using SampleDictionaries.UserControls;
using SampleDictionaries.Properties;
using Nat.Web.Tools.MailMessageContent;
using SampleDictionaries.Security;
using Nat.Web.Tools.ExtNet;
using Nat.Web.Tools.ExtNet.Extenders;
using Nat.Web.Tools.ExtNet.ExtNetConfig;
using Ext.Net;
using NullableTextBox = Ext.Net.NumberField;
using TextBox = Ext.Net.TextField;
using Label = Ext.Net.Label;
using DropDownListExt = Ext.Net.ComboBox;
using CheckBox = Ext.Net.Checkbox;
using RadioButton = Ext.Net.Radio;
using RadioButtonList = Ext.Net.RadioGroup;
using ImageButton = Ext.Net.ImageButton;
using HyperLink = Ext.Net.HyperLink;
using LinkButton = Ext.Net.LinkButton;
using DatePicker = Ext.Net.DateField;
using Panel = Ext.Net.Panel;
using Container = Ext.Net.Container;
using Newtonsoft.Json.Linq;
using AdditionalButtons = Nat.Web.Controls.ExtNet.AdditionalButtons;
using BrowseFilterParameters = Nat.Web.Tools.ExtNet.ExtNetBrowseFilterParameters;
using DBDataContext = SampleDictionaries.DBDataContext;

namespace SampleDictionaries.UserControls
{
    /// <summary>
    /// Контрол для просмотра, редактирования и добавления записей таблицы "Поступления/продажи товаров" (MyProductActions)
    /// </summary>
    [DefaultEvent("SelectedIndexChanged")]
    [ControlValueProperty("SelectedValue")]
    public partial class MyProductActionsEdit : Nat.Web.Controls.ExtNet.Generation.AbstractUserControl, IAccessControl, IScriptControl
    {
        #region Fields

        private DBDataContext _db;
        private long? refMyProductActions;
        private IEnumerable<ILogic> logics = new ILogic[] {  };
        private bool _isStartAction;
        private List<string> _addErrorMessages;
        private ControlInfo _info;
        private bool editlogicExecuted;
        private bool readlogicExecuted;
        private bool insertlogicExecuted;
        private bool _setDefaultValues;
        private bool _isNoPermit;
        private bool _selectedRowInited;
        private MyProductActionsJournalDataSourceView.Row _selectedRow;
        private MyProductAction _currentRow;
        private long? refLogMessage;
        private bool selectedValueInitialized;

        #endregion

        #region Partials

        partial void ReadLogic();
        partial void EditLogic();
        partial void InsertLogic();
        partial void EditInsertLogic();
        partial void Logic();
        partial void OnUpdating(MyProductAction newItem, MyProductAction originalItem);
        partial void OnInserting(MyProductAction newItem);
        partial void OnContextCreating(LinqDataSourceContextEventArgs e);
        partial void OnUpdated(LinqDataSourceStatusEventArgs e);
        partial void OnInserted(LinqDataSourceStatusEventArgs e);
        partial void OnDispose();
        partial void UpdateRefMyProductActions(MyProductAction row);
        partial void GetDefaultProperties(Dictionary<Type, List<string>> typeProperies);
        partial void GenerateAdditionalButtons(AdditionalButtons buttons);
        partial void GetBrowseFilterParameters(string fieldName, BrowseFilterParameters parameters);
        partial void CustomValidate_refProduct(long? value, BaseInformationValues information, CancelEventArgs args);
        partial void GetBrowseFilterParameters_refProduct(BrowseFilterParameters parameters);
        partial void GetValidators_refProduct(ValidateInformation validateInformation);
        partial void GetValidators_DateTimeAction(ValidateInformation validateInformation);
        partial void GetValidators_AmountChange(ValidateInformation validateInformation);
        partial void GetValidators_Note(ValidateInformation validateInformation);
        partial void ChangeLogTypeAdd(ref LogMessageType logType);
        partial void ChangeLogTypeLook(ref LogMessageType logType);
        partial void ChangeLogTypeEdit(ref LogMessageType logType);
        partial void ChangeLogTypeAdd(ref long logType);
        partial void ChangeLogTypeLook(ref long logType);
        partial void ChangeLogTypeEdit(ref long logType);
        partial void ChangeLogContent(ref string content, MyProductAction newItem, MyProductAction oldItem);
        partial void ChangeLogContentAdd(ref string content, MyProductAction newItem);
        partial void ChangeLogContentLook(ref string content, MyProductAction item);
        partial void ChangeLogContentEdit(ref string content, MyProductAction newItem, MyProductAction oldItem);
        partial void InitControlPanels();
        partial void OnPreRender();
        partial void OnInsertedPartial(MyProductAction newRow, bool inserted);
        partial void OnUpdatedPartial(MyProductAction newRow, MyProductAction originalItem, bool updated);
        partial void RemoteValidation_refProduct(JValue value, RemoteValidationEventArgs e);
        partial void RemoteValidation_DateTimeAction(JValue value, RemoteValidationEventArgs e);
        partial void RemoteValidation_AmountChange(JValue value, RemoteValidationEventArgs e);
        partial void RemoteValidation_Note(JValue value, RemoteValidationEventArgs e);

        #endregion

        #region Properties

        public DBDataContext DB
        {
            get
            {
                if (_db == null)
                {
                    _db = new DBDataContext(SpecificInstances.DbFactory.CreateConnection());
                }
        
                return _db;
            }
        }
        
        private List<string> AddErrorMessages
        {
            get
            {
                if (_addErrorMessages == null)
                    _addErrorMessages = source.View.AllowAddRowForTableTypes(NavigatorControl.Values, MyProductActionsResources.Header);
        
                return _addErrorMessages;
            }
        }
        
        [DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden)]
        [Browsable(false)]
        public ControlInfo Info
        {
            get
            {
                if (_info == null) 
                    _info = new ControlInfo(this){ DB = DB };
        
                return _info;
            }
        }
        
        protected bool RecordIsNew
        {
            get { return IsNew; }
        }
        
        protected bool RecordIsEditing
        {
            get { return SelectedValueKey != null && !IsNew && !IsRead; }
        }
        
        /// <summary>
        /// Действие логики выполняеться на начало редактирования или добавления записи, 
        /// true только однажды, при начале действий (открытии на редактирования или добавление).
        /// </summary>
        protected bool IsStartAction
        {
            get { return _isStartAction; }
        }
        
        public MyProductActionsJournalDataSourceView.Row SelectedRow
        {
            get
            {
                if (_selectedRow == null && !_selectedRowInited)
                {
                    if (string.IsNullOrEmpty(hfid.Text))
                        return null;
        
                    var key = Convert.ToInt64(hfid.Value);
                    _selectedRow = source.View.GetSelect(key).FirstOrDefault();
                    _selectedRowInited = true;
                }
        
                return _selectedRow;
            }
        }
        
        public MyProductActionsJournalDataSourceView.LookupValues SelectedLookup
        {
            get
            {
                if (ViewState["SelectedLookup"] != null)
                    return (MyProductActionsJournalDataSourceView.LookupValues)ViewState["SelectedLookup"];
        
                var row = SelectedRow;
                if (row == null || row.Lookup == null)
                    return null;
        
                ViewState["SelectedLookup"] = row.Lookup;
                return row.Lookup;
            }
        }
        
        private MyProductAction currentRow
        {
            get 
            {
                if (_currentRow == null && SelectedRow != null)
                    _currentRow = SelectedRow.Item;
        
                return _currentRow;
            }
            set { _currentRow = value; }
        }
        
        private bool HasErrors { get; set; }
        
        private string SessionKey
        { 
            get { return string.IsNullOrEmpty(hfSessionKey.Text) ? (hfSessionKey.Text = Request.Form[hfSessionKey.UniqueID] ?? Guid.NewGuid().ToString("N")) : hfSessionKey.Text; }
            set { hfSessionKey.Text = value; }
        }
        
        public override bool IsNew
        {
            get { return SelectedValueKey == null && base.IsNew; }
        }
        
        private MyProductActionsActivityController ActivityController { get; set; }
        
        private bool ActivityControllerInitialized { get; set; }
        
        private bool ValidateInformationFormInitialized { get; set; }
        
        private MyProductActionsValidateInformationForm ValidateInformationForm { get; set; }

        [Browsable(false)]
        public long? SelectedValueKey
        {
            get 
            {
                if (!IsPostBack && !selectedValueInitialized && Url.QueryParameters.ContainsKey("refMyProductActions"))
                {
                    selectedValueInitialized = true;
                    string value = Url.QueryParameters["refMyProductActions"];
                    if (!string.IsNullOrEmpty(value))
                        SelectedValueKey = Convert.ToInt64(value);
                }

                if (string.IsNullOrEmpty(hfid.Text))
                    return null;

                var key = Convert.ToInt64(hfid.Value);
                return key;
            }

            private set
            {
                hfid.Value = value == null 
                    ? string.Empty
                    : value.ToString();
            }
        }

        #region ISelectedValue Members
        
        [Browsable(false)]
        public override long SelectedValueLong
        {
            get 
            { 
                throw new NotImplementedException();
            }
        }
        
        public long? ParentID { get; set; }
        public bool IsSelectParentRows { get; set; }
        
        [Browsable(false)]
        public long? SelectedValueOrParentValue
        {
            get 
            {
                return SelectedValueKey;
            }
        }
        
        [Browsable(false)]
        public override object SelectedValue
        {
            get { return SelectedValueKey; }
        }
        
        [DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden), Browsable(false)]
        public override DataKey SelectedDataKey
        {
            get 
            {
                throw new NotImplementedException();
            }
        }
        
        [DefaultValue("ID")]
        [Editor(
            "System.Web.UI.Design.WebControls.DataFieldEditor, System.Design, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"
            , typeof(UITypeEditor))]
        [TypeConverter(typeof(StringArrayConverter))]
        [Category("Data")]
        public override string[] DataKeyNames
        {
            get 
            { 
                throw new NotImplementedException();
            }
        
            set
            { 
                throw new NotImplementedException();
            }
        }
        
        public override Type TableType
        {
            get { return typeof(MyProductAction); }
        }
        
        #endregion
        
        #endregion
        
        #region Methods
        
        public override void Dispose()
        {
            if (DB.Transaction != null)
                RollbackDBTransaction();
        
            DB.Dispose();
            OnDispose();
            base.Dispose();
        }
        
        protected DbTransaction BeginTransaction()
        {
            if (DB.Connection.State == ConnectionState.Closed)
                DB.Connection.Open();
            var transaction = DB.Transaction = DB.Connection.BeginTransaction();
            InitTransaction();
            return transaction;
        }
        
        protected void CommitDBTransaction()
        {
            if (DB.Transaction.Connection != null)
                DB.Transaction.Commit();
            EndTransaction();  
        }
        
        protected void RollbackDBTransaction()
        {
            if (DB.Transaction.Connection != null)
                DB.Transaction.Rollback();
            EndTransaction();  
        }
        
        protected void EndTransaction()
        {
            DB.Transaction?.Dispose();
            DB.Transaction = null;
            InitTransaction();
            
            if (DB.Connection.State == ConnectionState.Open)
                DB.Connection.Close();
        }
        
        protected void InitTransaction()
        {
            source.View.InitTransaction = DB.Transaction;
            jdsrefProduct.BaseView.InitTransaction = DB.Transaction;
        }
        
        protected void InitConnection()
        {
            source.View.InitConnection = DB.Connection;
            jdsrefProduct.BaseView.InitConnection = DB.Connection;
        }
        
        protected bool AddErrorMessage(IEnumerable<string> errors)
        {
            if (errors != null && errors.Any())
            {
                foreach (var message in errors)
                    AddErrorMessage(message);
                return true;
            }
        
            return false;
        }
        
        
        private Dictionary<Type, List<string>> GetDefaultProperties()
        {
            var properties = (Dictionary<Type, List<string>>)Cache["MyProductActions_DefaultProperties"];
            if (properties == null)
            {
                properties = new Dictionary<Type, List<string>>();
        
                foreach (var property in typeof(MyProductAction).GetProperties())
                {
                    var attributes = (AssociationAttribute[])property.GetCustomAttributes(typeof(AssociationAttribute), false);
                    if(attributes != null && attributes.Length == 1 && attributes[0].IsForeignKey && !"refHistory".Equals(attributes[0].ThisKey))
                    {
                        if(!properties.ContainsKey(property.PropertyType))
                            properties.Add(property.PropertyType, new List<string>());
                        properties[property.PropertyType].Add(attributes[0].ThisKey);
                    }
                }
        
                GetDefaultProperties(properties);
                Cache["MyProductActions_DefaultProperties"] = properties;
            }
        
            return properties;
        }
        
        protected string GetBrowseUrl(string fieldName, object value, long? id)
        {
            var parameters = new BrowseFilterParameters();
            string selectColumnName = null;
            switch (fieldName)
            {
                case "refProduct":
                    GetBrowseFilterParameters_refProduct(parameters);
                    GetBrowseFilterParameters("refProduct", parameters);
                    break;
        
            }
        
            var jss = new JavaScriptSerializer();
            return jss.Serialize(new Triplet(parameters.ClientControlParameters, parameters.ClientValueParameters, selectColumnName));
        }
        
        protected virtual void EnsureLogicExecute()
        {
            if (SelectedValueKey == null && !IsNew)
                return;
            var executing = false;
            Trace.Write("MyProductActions", "MyProductActionsEdit.EnsureLogicExecute.Begin");
            if (SelectedValueKey != null && IsRead && !readlogicExecuted)
            {
                readlogicExecuted = true;
                Info.IsRead = true;
                Info.ComputeReadOnlyFields(true);
                ReadLogic();
                Logic();
                executing = true;
            }
        
            if (SelectedValueKey != null && !IsNew && !IsRead && !editlogicExecuted)
            {
                editlogicExecuted = true;
                Info.IsEdit = true;
                Info.ComputeReadOnlyFields(true);
                UploadFiles();
                ExecuteEditLogic();
                EditInsertLogic();
                Logic();
                InitializeFilterParameters();
                executing = true;
            }
        
            if (IsNew && !insertlogicExecuted)
            {
                insertlogicExecuted = true;
                Info.IsInsert = true;
                if (IsStartAction)
                    SetDefaultValues();
                Info.ComputeReadOnlyFields(true);
                UploadFiles();
                ExecuteInsertLogic();
                EditInsertLogic();
                Logic();
                InitializeFilterParameters();
                executing = true;
            }
        
            if (executing)
            {
                foreach (var logic in logics)
                {
                    logic.IsEdit = SelectedValueKey != null && !IsNew && !IsRead;
                    logic.IsNew = IsNew;
                    logic.IsStartAction = IsStartAction;
                    logic.ControlInfo = Info;
                    logic.NavigatorValues = NavigatorControl.Values;
                    logic.Url = Url;
                    logic.Logic();
                }
        
                Info.ComputeReadOnlyFields(false);
                if (IsStartAction && IsNew)
                    ValidateReferences(true);
            }
        
            Trace.Write("MyProductActions", "MyProductActionsEdit.EnsureLogicExecute.End");
        }
        
        protected virtual void ExecuteInsertLogic()
        {
            InsertLogic();
        }
        
        protected virtual void ExecuteEditLogic()
        {
            EditLogic();
        }
        
        private void InitializeFilterParameters()
        {
            BrowseFilterParameters parameters;
        }
        
        /// <summary>
        /// Проверка ссылок на валидность.
        /// </summary>
        /// <param name="isDefault">Флаг о том что заполнены поля по умолчанию.</param>
        private bool ValidateReferences(bool isDefault)
        {
            var isValid = true;
            Trace.Write("MyProductActions", "MyProductActionsEdit.ValidateReferences.Begin");
        
            if (Info.refProduct != null)
            {
                var value = Info.refProduct.Value;
                CancelEventArgs args = new RecordValidateArgs(false, IsNew || SelectedRow.Item.refProduct != Info.refProduct);
                var info = jdsrefProduct.BaseView.Validate(value, (RecordValidateArgs)args);
                if (args.Cancel)
                {
                    AddErrorMessage(string.Format(
                                        isDefault
                                            ? Nat.Web.Controls.Properties.Resources.ENotCorrectDefaultValue
                                            : Nat.Web.Controls.Properties.Resources.ENotCorrectValue,
                                        GenerationHelper.GetHeaderName(MyProductActionsResources.refProduct__Group, MyProductActionsResources.refProduct__Header)));
                    isValid = false;
                }
        
                if (info != null)
                {
                    if (!info.IsValid)
                    {
                        AddErrorMessage(string.Format(Nat.Web.Controls.Properties.Resources.SFieldHasError,
                                                      GenerationHelper.GetHeaderName(MyProductActionsResources.refProduct__Group, MyProductActionsResources.refProduct__Header))
                                        + info.IconHtml + info.MessageHtml);
                        isValid = false;
                    }
                    else
                    {
                        args = new CancelEventArgs();
                        CustomValidate_refProduct(value, info, args);
                        if (args.Cancel) isValid = false;
                    }
                }
            }
        
            Trace.Write("MyProductActions", "MyProductActionsEdit.ValidateReferences.End");
            return isValid;
        }

        protected IFilterControl GetFilterControl(DBDataContext db)
        {
            var filterControlInternal = new MyProductActionsFilter { Page = Page };
            filterControlInternal.SetUrl(Url);
            filterControlInternal.SetDB(db);
            filterControlInternal.SelectedID = SelectedValueKey;
            filterControlInternal.ShowHistory = true;
            return filterControlInternal;
        }

        
        
        /// <summary>
        /// Сохранение формы.
        /// </summary>
        /// <param name="sender">Объект вызвавший событие.</param>
        /// <param name="e">Параметры события.</param>
        protected void SaveData(object sender, DirectEventArgs e)
        {
            MyProductAction originalItem = null;
        
            using (var db = new DBDataContext(DB.Connection ?? SpecificInstances.DbFactory.CreateConnection()))
            {
                // Если запись редактируется, то получаем строку из базы и проверяем версии записи
                if (!IsNew)
                {
                    source.View.DB.Dispose();
                    source.View.DB = db;
                    var row = source.View.GetSelect(SelectedValueKey.Value)
                        .Select(r => new { r.Item, r.CanEdit })
                        .FirstOrDefault();
                    if (row == null)
                    {
                        AddErrorMessage(Nat.Web.Controls.Properties.Resources.ERowIsDeletedOrNotHavePermissions);
                        source.View.DB = null;
                        return;
                    }
                    else if (!row.CanEdit)
                    {
                        AddErrorMessage(Nat.Web.Controls.Properties.Resources.EDoesNotHavePermitForEdit);
                        source.View.DB = null;
                        return;
                    }
        
                    originalItem = row.Item;
                    source.View.DB = new DBDataContext(DB.Connection ?? SpecificInstances.DbFactory.CreateConnection());
                    if (originalItem == null)
                    {
                        AddErrorMessage(Nat.Web.Controls.Properties.Resources.ERowIsDeletedOrNotHavePermissions);
                        return;
                    }
                    
                    var rowVersion = Convert.ToBase64String(originalItem.RowVersion.ToArray());
                    if (rowVersion != rowVersionHiddenField.Text)
                    {
                        // todo: подумать о реализации конкурентных изменений
                        AddErrorMessage(Nat.Web.Controls.Properties.Resources.ERecordModifiedByOther);
                        return;
                    }
                }
        
                if (SaveData(originalItem))
                {
                    if (!IsNew && Url.QueryParameters.ContainsKey("MultipleEdit"))
                    {
                        var keys = Url.QueryParameters["MultipleEdit"].Split(new[] {','}, StringSplitOptions.RemoveEmptyEntries).Select(r => Convert.ToInt64(r)).ToArray();
                        var data = source.View.GetSelect().Where(r => keys.Contains(r.id)).Where(r => r.CanEdit);
                        foreach(var otherRow in data)
                            SaveData(otherRow.Item);
                    }
        
                    IsNew = false;
                    IsRead = false;
                    Info.IsEdit = true;
                    editlogicExecuted = false;
                    insertlogicExecuted = false;
                    readlogicExecuted = false;
                    source.View.DB.Dispose();
                    source.View.DB = new DBDataContext(DB.Connection ?? SpecificInstances.DbFactory.CreateConnection());
                    UpdateForm(true);
        
                    ResourceManager.AddInstanceScript(
                        string.Format(
                            "if (window.frameElement != null && window.frameElement.CloseOnSaveSuccessfull != null)\r\n" +
                            "    window.frameElement.CloseOnSaveSuccessfull({0});",
                            SelectedValueKey));
                }
            }
        }
        
        protected bool SaveData(MyProductAction originalItem)
        {
            // Выполняем логику формы
            EnsureLogicExecute();
        
            // Валидируем
            var valid = ValidateInfo();
            var newItem = GetNewItem(originalItem);
            valid = valid & ValidateReferences(false);
            if (!valid) return false;
        
            // Добавляем запись в модель на обновление или добавление
            if (IsNew)
            {
                if (!AccessOptions.CheckPermitAdd())
                {
                    AddErrorMessage(Nat.Web.Controls.Properties.Resources.EDoesNotHavePermitForAdd);
                    return false;
                }
        
                DB.MyProductActions.InsertOnSubmit(newItem);
                OnInserting(newItem);
                Inserting(newItem);
            }
            else
            {
                DB.MyProductActions.Attach(newItem, originalItem);
                OnUpdating(newItem, originalItem);
                Updating(originalItem, newItem);
            }
        
            // todo: разрулить Exception на базе
            // Обновляем в БД
            try
            {
                DB.SubmitChanges();
        
                // Вызываем события о том что обновленно
                if (IsNew)
                {
                    OnInserted(true, newItem);
                    OnInsertedPartial(newItem, true);
                }
                else
                {
                    OnUpdated(true, newItem);
                    OnUpdatedPartial(newItem, originalItem, true);
                }
        
                SelectedValueKey = refMyProductActions;
                return true;
            }
            catch (SqlException ex)
            {
                if (ex.Errors[0].Number > 50000)
                    AddErrorMessage(ex.Errors[0].Message);
                else
                    X.Msg.Alert("Exception", ex.ToString()).Show();
                return false;
            }
            catch(Exception ex)
            {
                X.Msg.Alert("Exception", ex.ToString()).Show();
                return false;
            }
        }
        
        /// <summary>
        /// Получение новой строки для вставки или обновления.
        /// </summary>
        /// <param name="originalValues">Строка с оригинальными значениями.</param>
        protected MyProductAction GetNewItem(MyProductAction originalValues)
        {
            MyProductAction newItem;
        
            // Создание нового элемента
            if (originalValues == null)
                newItem = new MyProductAction();
            else
            {
                // Создание нового элемента и копирование из оригинала значений полей
                newItem = new MyProductAction
                    {
                        id = originalValues.id,
                        DateTimeAction = originalValues.DateTimeAction,
                        RowVersion = originalValues.RowVersion,
                    };
            }
        
            // Получение значений полей из Info
            if (Info.refProduct != null)
                newItem.refProduct = (Int64)Info.refProduct;
            else
                newItem.refProduct = default(Int64);
            if (Info.AmountChange != null)
                newItem.AmountChange = (Decimal)Info.AmountChange;
            else
                newItem.AmountChange = default(Decimal);
            if (!string.IsNullOrEmpty(Info.Note))
                newItem.Note = Info.Note;
            else
                newItem.Note = null;
        
            return newItem;
        }
        
        /// <summary>
        /// Проверка данных на валидность.
        /// </summary>
        protected bool ValidateInfo()
        {
            EnsureActivityControllerInitialized();
            ActivityController.ComputeActivities();
            EnsureValidateInformationFormInitialized();
        
            var valid = ValidateInformationForm.Validate();
            valid = valid & ValidateField_refProduct();
            valid = valid & ValidateField_DateTimeAction();
            valid = valid & ValidateField_AmountChange();
            valid = valid & ValidateField_Note();
        
            return valid;
        }
        
        partial void ValidateField_refProduct(ref bool valid);
        
        private bool ValidateField_refProduct()
        {
            var valid = true;
            if (ActivityController.refProductControl.AllowRequiredValidate || ValidateInformationForm.IsRequired("refProduct"))
                valid = Info.refProduct != null;
        
            if (!valid)
            {
                AddErrorMessage(GetRequiredMessage_refProduct());
                return false;
            }
        
            if (ActivityController.refProductControl.AllowValidate)
                ValidateField_refProduct(ref valid);
        
            return valid;
        }
        
        partial void ValidateField_DateTimeAction(ref bool valid);
        
        private bool ValidateField_DateTimeAction()
        {
            var valid = true;
            if (ActivityController.DateTimeActionControl.AllowRequiredValidate || ValidateInformationForm.IsRequired("DateTimeAction"))
                valid = Info.DateTimeAction != null;
        
            if (!valid)
            {
                AddErrorMessage(GetRequiredMessage_DateTimeAction());
                return false;
            }
        
            if (ActivityController.DateTimeActionControl.AllowValidate)
                ValidateField_DateTimeAction(ref valid);
        
            return valid;
        }
        
        partial void ValidateField_AmountChange(ref bool valid);
        
        private bool ValidateField_AmountChange()
        {
            var valid = true;
            if (ActivityController.AmountChangeControl.AllowRequiredValidate || ValidateInformationForm.IsRequired("AmountChange"))
                valid = Info.AmountChange != null;
        
            if (!valid)
            {
                AddErrorMessage(GetRequiredMessage_AmountChange());
                return false;
            }
        
            if (ActivityController.AmountChangeControl.AllowValidate)
                ValidateField_AmountChange(ref valid);
        
            return valid;
        }
        
        partial void ValidateField_Note(ref bool valid);
        
        private bool ValidateField_Note()
        {
            var valid = true;
            if (ActivityController.NoteControl.AllowRequiredValidate || ValidateInformationForm.IsRequired("Note"))
                valid = !string.IsNullOrEmpty(Info.Note);
        
            if (!valid)
            {
                AddErrorMessage(GetRequiredMessage_Note());
                return false;
            }
        
            if (ActivityController.NoteControl.AllowValidate)
                ValidateField_Note(ref valid);
        
            return valid;
        }
        
        private void UpdateForm(bool loadRow)
        {
            if (!IsPostBack)
                loadRow = true;
        
            if (IsRead)
                Info.IsRead = true;
        
            if (!IsNew && loadRow)
            {
                var row = SelectedValueKey == null ? null : source.View.GetSelect(SelectedValueKey.Value).FirstOrDefault();
                if (row == null)
                {
                    if (SelectedValueKey != null)
                        AddErrorMessage(Nat.Web.Controls.Properties.Resources.ERowIsDeletedOrNotHavePermissions);
                    SelectedValueKey = null;
                    IsRead = true;
                    Info.IsRead = true;
                    FormPanelMyProductActions.Hidden = true;
                    return;
                }
        
                if (!AccessOptions.CheckPermitEdit())
                {
                    if (!IsRead)
                        AddErrorMessage(Nat.Web.Controls.Properties.Resources.EDoesNotHavePermitForEdit);
                    IsRead = true;
                    Info.IsRead = true;
                }
                else if (!row.CanEdit)
                {
                    if (!IsRead)
                    {
                        var messages = source.View.GetEditErrors(SelectedValueKey.Value, MyProductActionsResources.Header);
                        if (messages.All(string.IsNullOrEmpty))
                            AddErrorMessage(Nat.Web.Controls.Properties.Resources.EDoesNotHavePermitForEdit);
                        else
                            AddErrorMessage(messages.Where(r => !string.IsNullOrEmpty(r)));
                    }
        
                    IsRead = true;
                    Info.IsRead = true;
                }
        
                rowVersionHiddenField.Text = Convert.ToBase64String(row.Item.RowVersion.ToArray());
                object data;
                data = 
                    new[]
                        {
                            new
                                {
                                    id = row.Item.refProduct,
                                    RowName = MyProductActionsCacheNames.GetByTime_refProduct(DB, row.Item),
                                    //AdditionalValues = row.AdditionalValues,
                                },
                        };
                if (Page.IsPostBack)
                    Store_refProduct.LoadData(data, true);
                else
                    Store_refProduct.Data = data;
        
                FormPanelMyProductActions.SetValues(
                    new 
                        {
                            row.Item.refProduct,
                            row.Item.DateTimeAction,
                            row.Item.AmountChange,
                            row.Item.Note,
                        });
                UpdateForm(row.Item);
                FormPanelMyProductActions.DataBind();
            }
            else if (IsNew && !AccessOptions.CheckPermitAdd())
            {
                AddErrorMessage(Nat.Web.Controls.Properties.Resources.EDoesNotHavePermitForAdd);
                IsNew = false;
                IsRead = true;
                Info.IsRead = true;
                UpdateFormToNull();
            }
            else if (IsNew && loadRow)
            {
                var messages = source.View.AllowAddRowForTableTypes(NavigatorControl.Values, MyProductActionsResources.Header).ToList();
                if (messages.Any(r => !string.IsNullOrEmpty(r)))
                {
                    foreach(var message in messages.Where(r => !string.IsNullOrEmpty(r)))
                        AddErrorMessage(message);
                    IsNew = false;
                    IsRead = true;
                    Info.IsRead = true;
                    UpdateFormToNull();
                }
                else if (messages.Any(string.IsNullOrEmpty))
                {
                    AddErrorMessage(Nat.Web.Controls.Properties.Resources.EDoesNotHavePermitForAdd);
                    IsNew = false;
                    IsRead = true;
                    Info.IsRead = true;
                    UpdateFormToNull();
                }
                else
                {
                    rowVersionHiddenField.Text = string.Empty;
                    FormPanelMyProductActions.SetValues(null);
                    UpdateFormToNull();
                    FormPanelMyProductActions.DataBind();
                }
            }
        }
        
        private void UpdateForm(MyProductAction row)
        {
            Info.refProduct = row.refProduct;
            Info.DateTimeAction = row.DateTimeAction;
            Info.AmountChange = row.AmountChange;
            Info.Note = row.Note;
        }
        
        private void UpdateFormToNull()
        {
            Info.refProduct = null;
            Info.DateTimeAction = null;
            Info.AmountChange = null;
            Info.Note = null;
        }
        
        private void GenerateHtmlAdditionalButtonsInternal()
        {
            var toolbar = FormPanelMyProductActions.BottomBar.First();
            Action<AbstractComponent> addButton = commponent => toolbar.Items.Add(commponent);
            Action<AbstractComponent, AbstractComponent> insertAfterButton = (commponent, after) => toolbar.Items.Insert(toolbar.Items.IndexOf(after) + 1, commponent);
            var buttons = new AdditionalButtons(addButton, insertAfterButton);
            GenerateAdditionalButtons(buttons);
        }
        
        private void InitComboBoxViews()
        {
        }
        
        protected override IWorkFlow[] CreateWorkFlows()
        {
            return new IWorkFlow[] {};
        }
        
        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);
            InitConnection();
            GenerateHtmlAdditionalButtonsInternal();
            InitControlPanels();
            InitComboBoxViews();
        }
        
        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);
        
            if (!IsPostBack || IsFirstCreation)
                _isStartAction = true;
        
            UpdateForm(false);
        }
        
        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);
        
            EnsureLogicExecute();
            EnsureActivityControllerInitialized();
            ActivityController.ComputeActivities();
            EnsureValidateInformationFormInitialized();
        
            if (!DesignMode)
                ScriptManager.GetCurrent(Page).RegisterScriptControl(this);
        
            if ((IsNew && AccessOptions.CheckPermitAdd()) || (!IsRead && AccessOptions.CheckPermitEdit()))
            {
                SaveButton.Show();
                SaveButton.Hidden = false;
            }
            else
            {
                SaveButton.Hide();
                SaveButton.Hidden = true;
            }
            OnPreRender();
        }
        
        protected override void Render(HtmlTextWriter writer)
        {
            base.Render(writer);
            if (!DesignMode)
                ScriptManager.GetCurrent(Page).RegisterScriptDescriptors(this);
        }
        
        IEnumerable<ScriptDescriptor> IScriptControl.GetScriptDescriptors()
        {
            if (FormPanelMyProductActions.Hidden)
                return new ScriptDescriptor[0];
            return ((IScriptControl)ActivityController).GetScriptDescriptors();
        }
        
        IEnumerable<ScriptReference> IScriptControl.GetScriptReferences()
        {
            return ((IScriptControl)ActivityController).GetScriptReferences();
        }
        
        
        private void SetDefaultValues()
        {
            _setDefaultValues = true;
            Info.refProduct = NavigatorControl.Values.MyProducts;
        }
        
        
        private bool _refProductInitedFeild;
        
        
        public void EnsureInitedDefaultValue(Type type)
        {
            if (!IsStartAction || _setDefaultValues || _isNoPermit || !IsNew) return;
            if (type == typeof(MyProduct))
            {
                if (_refProductInitedFeild) return;
                _refProductInitedFeild = true;
                Info.refProduct = NavigatorControl.Values.MyProducts;
                return;
            }
        }
        
        private void SetDefaultValues(MyProductAction item)
        {
            var properties = GetDefaultProperties();
        }
        
        protected void EnsureActivityControllerInitialized()
        {
            if (ActivityControllerInitialized)
                return;
            ActivityControllerInitialized = true;
            ActivityController = new MyProductActionsActivityController();
            var dic = GetValuesForActivityController();
            ActivityController.Initialize(this, dic, Info);
        }
        
        private Dictionary<string, object> GetValuesForActivityController()
        {
            var dic = new Dictionary<string, object>();
            dic["refProduct"] = Info.refProduct;
            dic["DateTimeAction"] = Info.DateTimeAction;
            dic["AmountChange"] = Info.AmountChange;
            dic["Note"] = Info.Note;
        
            return dic;
        }
        
        protected void EnsureValidateInformationFormInitialized()
        {
            if (ValidateInformationFormInitialized)
                return;
        
            ValidateInformationFormInitialized = true;
            ValidateInformationForm = 
                new MyProductActionsValidateInformationForm(FormPanelMyProductActions)
                    {
                        ValidationGroup = "MyProductActions",
                    };
        
        
            GetValidators_refProduct(ValidateInformationForm.refProduct);
            ValidateInformationForm.AddDefaultValidatorsForrefProduct(Info);
            ValidateInformationForm.ApplyValidators(
                new ValidateInformationFormApplyArgsInfo
                    {
                        ValidatorCode = "refProduct",
                        Control = Info.refProductControl,
                        ReadOnly = ActivityController.refProductControl.ReadOnly,
                        ValidationContainer = "phrefProduct",
                    });
        
            GetValidators_DateTimeAction(ValidateInformationForm.DateTimeAction);
            ValidateInformationForm.AddDefaultValidatorsForDateTimeAction(Info);
            ValidateInformationForm.ApplyValidators(
                new ValidateInformationFormApplyArgsInfo
                    {
                        ValidatorCode = "DateTimeAction",
                        Control = Info.DateTimeActionControl,
                        ReadOnly = true,
                        ValidationContainer = "phDateTimeAction",
                    });
        
            GetValidators_AmountChange(ValidateInformationForm.AmountChange);
            ValidateInformationForm.AddDefaultValidatorsForAmountChange(Info);
            ValidateInformationForm.ApplyValidators(
                new ValidateInformationFormApplyArgsInfo
                    {
                        ValidatorCode = "AmountChange",
                        Control = Info.AmountChangeControl,
                        ReadOnly = ActivityController.AmountChangeControl.ReadOnly,
                        ValidationContainer = "phAmountChange",
                    });
        
            GetValidators_Note(ValidateInformationForm.Note);
            ValidateInformationForm.AddDefaultValidatorsForNote(Info);
            ValidateInformationForm.ApplyValidators(
                new ValidateInformationFormApplyArgsInfo
                    {
                        ValidatorCode = "Note",
                        Control = Info.NoteControl,
                        ReadOnly = ActivityController.NoteControl.ReadOnly,
                        ValidationContainer = "phNote",
                    });
        }
        
        private void SetReadOnlyValues(MyProductAction item)
        {
        }
        
        private void SetOtherValues(MyProductAction item)
        {
        }
        
        private void SetMultipleKeyValues(MyProductAction item)
        {
        }
        
        private void UploadFilesUpdateItem(MyProductAction item)
        {
        }
        
        private void UploadFiles()
        {
        }

        public void RemoteValidationFields(object sender, RemoteValidationEventArgs e)
        {
            var value = (JValue)e.Value;
            e.Success = true;
            switch (e.Name)
            {
                case "refProduct":
                    RemoteValidation_refProduct(value, e);
                    break;
                case "DateTimeAction":
                    RemoteValidation_DateTimeAction(value, e);
                    break;
                case "AmountChange":
                    RemoteValidation_AmountChange(value, e);
                    break;
                case "Note":
                    RemoteValidation_Note(value, e);
                    break;
            }
        }

        #endregion
        
        #region Events
        
        protected void lds_Inserted(object sender, LinqDataSourceStatusEventArgs e)
        {
            var row = e.Result as MyProductAction;
            OnInserted(row != null, row);
            OnInserted(e);
        
            if (row != null && !HasErrors)
            {
                if (DB.Transaction != null)
                    CommitDBTransaction();
            }
        }
        
        protected void lds_Updated(object sender, LinqDataSourceStatusEventArgs e)
        {
            var row = e.Result as MyProductAction;
            var hasRow = row != null;
            OnUpdated(hasRow, row);
            OnUpdated(e);
        
            if (row != null && !HasErrors)
            {
                if (DB.Transaction != null)
                    CommitDBTransaction();
            }
        }
        
        protected void OnInserted(bool inserted, MyProductAction row)
        {
            if (inserted)
            {
               refMyProductActions = row.id;
            }
        
            foreach (var logic in logics)
            {
                var errors = logic.AfterSave(inserted, row);
                if (errors != null && errors.Count > 0)
                {
                    foreach(var message in errors)
                        AddErrorMessage(message);
                    break;
                }
            }
        
                #region InsertChildCollections
            if (row != null)
            {
                
            }
            #endregion
        
            if (row != null)
            {
                foreach (var wf in WorkFlows)
                {
                    wf.DataContext = DB;
                    wf.BaseControlInfo = Info;
                    wf.JournalControl = this;
                    wf.OnInserted(row);
                }
            }
        }
        
        protected void OnUpdated(bool updated, MyProductAction row)
        {
            if (updated)
            {
                refMyProductActions = row.id;
                UpdateRefMyProductActions(row);
            }
        
            foreach (var logic in logics)
            {
                var errors = logic.AfterSave(updated, row);
                if (errors != null && errors.Count > 0)
                {
                    foreach(var message in errors)
                        AddErrorMessage(message);
                    break;
                }
            }
        
            #region UpdateChildCollections
            if (row != null)
            {
                
            }
            #endregion
        
            if (row != null)
            {
                foreach (var wf in WorkFlows)
                {
                    wf.DataContext = DB;
                    wf.BaseControlInfo = Info;
                    wf.JournalControl = this;
                    wf.OnUpdated(row, refMyProductActions.ToString());
                }
            }
        }
        
        protected void ldsChanges_Selecting(object sender, LinqDataSourceSelectEventArgs e)
        {
        }
        
        protected void lds_Selecting(object sender, LinqDataSourceSelectEventArgs e)
        {
        }
        
        protected void lds_Updating(object sender, LinqDataSourceUpdateEventArgs e)
        {
            if (e.Exception != null)
            {
                AddErrorMessage(e.Exception.Message);
                LogMonitor.LogException(e.Exception);
                e.ExceptionHandled = true;
                return;
            }
        
            SetReadOnlyValues((MyProductAction)e.NewObject);
            SetMultipleKeyValues((MyProductAction)e.NewObject);
            SetOtherValues((MyProductAction)e.NewObject);
            e.Cancel = !Updating((MyProductAction)e.OriginalObject, (MyProductAction)e.NewObject);
        }
        
        protected void ldsChanges_Updating(object sender, LinqDataSourceUpdateEventArgs e)
        {
            if (e.Exception != null)
            {
                AddErrorMessage(e.Exception.Message);
                LogMonitor.LogException(e.Exception);
                e.ExceptionHandled = true;
                return;
            }
        
            SetReadOnlyValues((MyProductAction)e.NewObject);
            SetMultipleKeyValues((MyProductAction)e.NewObject);
            SetOtherValues((MyProductAction)e.NewObject);
            e.Cancel = !Updating((MyProductAction)e.OriginalObject, (MyProductAction)e.NewObject);
        }
        
        protected void lds_Inserting(object sender, LinqDataSourceInsertEventArgs e)
        {
            if (e.Exception != null)
            {
                AddErrorMessage(e.Exception.Message);
                LogMonitor.LogException(e.Exception);
                e.ExceptionHandled = true;
                return;
            }
        
            SetReadOnlyValues((MyProductAction)e.NewObject);
            SetMultipleKeyValues((MyProductAction)e.NewObject);
            SetOtherValues((MyProductAction)e.NewObject);
            e.Cancel = !Inserting((MyProductAction) e.NewObject);
        }
        
        protected void ldsChanges_Inserting(object sender, LinqDataSourceInsertEventArgs e)
        {
            if (e.Exception != null)
            {
                AddErrorMessage(e.Exception.Message);
                LogMonitor.LogException(e.Exception);
                e.ExceptionHandled = true;
                return;
            }
        
            SetReadOnlyValues((MyProductAction)e.NewObject);
            SetMultipleKeyValues((MyProductAction)e.NewObject);
            SetOtherValues((MyProductAction)e.NewObject);
            e.Cancel = !Inserting((MyProductAction) e.NewObject);
        }
        
        protected void Source_Selecting(object sender, DataSourceSelectingEventArgs e)
        {
            e.FilterControl = GetFilterControl((DBDataContext)e.DB);
        }
        
        protected void lds_ContextCreating(object sender, LinqDataSourceContextEventArgs e)
        {
            OnContextCreating(e);
            e.ObjectInstance = DB;
        }
        
        protected void lds_ContextDisposing(object sender, LinqDataSourceDisposeEventArgs e)
        {
            if (_db != null && _db.Transaction != null)
                RollbackDBTransaction();
            _db = null;
            var d = (IDisposable)e.ObjectInstance;
            d.Dispose();
        }
        
        
           protected void jdsrefProduct_Selecting(object sender, DataSourceSelectingEventArgs e)
           {
               long? value;
               long? newValue = null;
               if (currentRow != null)
               {
                   long? initNewValue;
                   initNewValue = currentRow.refProduct;
                   newValue = initNewValue;
               }
               var parameters = new BrowseFilterParameters();
               GetBrowseFilterParameters_refProduct(parameters);
               GetBrowseFilterParameters("refProduct", parameters);
               jdsrefProduct.BaseView.SelectParameters = Info.Get_refProductSelectParameters();
               var control = 
                   jdsrefProduct.BaseView.CreateDefaultFilter(
                       "SampleDictionaries.UserControls.MyProductsFilter",
                       "MyProducts",
                       "none",
                       newValue,
                       parameters,
                       e.DB);
               e.FilterControl = control;
           }
        
        #endregion

        #region Permission
        
        bool IAccessControl.CheckPermit(Page page)
        {
            return AccessOptions.CheckPermit();
        }
        
        #endregion

        #region Log
        
        private LogMonitor _logMonitor;
        protected LogMonitor LogMonitor
        {
            get
            {
                if(_logMonitor == null)
                {
                    _logMonitor = new LogMonitor();
                    _logMonitor.Init();
                }
                return _logMonitor;
            }
        }

        protected bool Inserting(MyProductAction newRow)
        {
        
            return true;
        }

        protected bool Updating(MyProductAction originalRow, MyProductAction newRow)
        {
        
            return true;
        }
        
        #endregion

        #region EMailMessages

            

        #endregion
        
        #region Methods for help to show messages

        public static string GetRequiredMessage(string group, string header)
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SRequiredFieldMessage, GenerationHelper.GetHeaderName(group, header));
        }
        /// <summary>
        /// Сообщение об обязательности поля 'Мой товар'.
        /// </summary>
        public static string GetRequiredMessage_refProduct()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SRequiredFieldMessage, GenerationHelper.GetHeaderName(MyProductActionsResources.refProduct__Group, MyProductActionsResources.refProduct__Header));
        }
        
        /// <summary>
        /// Сообщение об обязательности поля 'Дата/время действия'.
        /// </summary>
        public static string GetRequiredMessage_DateTimeAction()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SRequiredFieldMessage, GenerationHelper.GetHeaderName(MyProductActionsResources.DateTimeAction__Group, MyProductActionsResources.DateTimeAction__Header));
        }
        
        /// <summary>
        /// Сообщение об обязательности поля 'Изменение кол-ва'.
        /// </summary>
        public static string GetRequiredMessage_AmountChange()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SRequiredFieldMessage, GenerationHelper.GetHeaderName(MyProductActionsResources.AmountChange__Group, MyProductActionsResources.AmountChange__Header));
        }
        
        /// <summary>
        /// Сообщение об обязательности поля 'Примечание'.
        /// </summary>
        public static string GetRequiredMessage_Note()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SRequiredFieldMessage, GenerationHelper.GetHeaderName(MyProductActionsResources.Note__Group, MyProductActionsResources.Note__Header));
        }
        
        public static string GetMaxLengthMessage(int length)
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SMaxLength, length);
        }
        /// <summary>
        /// Сообщение о максимальной длине 7 поля 'Изменение кол-ва'.
        /// </summary>
        public static string GetMaxLengthOfField_AmountChange()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SMaxLengthOfField, GenerationHelper.GetHeaderName(MyProductActionsResources.AmountChange__Group, MyProductActionsResources.AmountChange__Header), 7);
        }
        
        /// <summary>
        /// Сообщение о максимальной длине 500 поля 'Примечание'.
        /// </summary>
        public static string GetMaxLengthOfField_Note()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SMaxLengthOfField, GenerationHelper.GetHeaderName(MyProductActionsResources.Note__Group, MyProductActionsResources.Note__Header), 500);
        }
        
        /// <summary>
        /// Сообщение о не корректном вводе числового значения в поле 'Изменение кол-ва'.
        /// </summary>
        public static string GetNotCorrectNumberMessage_AmountChange()
        {
            return string.Format(Nat.Web.Controls.Properties.Resources.SNotCorrectNumberOfField, GenerationHelper.GetHeaderName(MyProductActionsResources.AmountChange__Group, MyProductActionsResources.AmountChange__Header));
        }
        
        /// <summary>
        /// Заголовок колнки 'Мой товар'. Берется из ресурсов с учетов группы.
        /// </summary>
        public static string GetHeaderOfColumn_refProduct()
        {
            return GenerationHelper.GetHeaderName(MyProductActionsResources.refProduct__Group, MyProductActionsResources.refProduct__Header);
        }
        
        /// <summary>
        /// Заголовок колнки 'Дата/время действия'. Берется из ресурсов с учетов группы.
        /// </summary>
        public static string GetHeaderOfColumn_DateTimeAction()
        {
            return GenerationHelper.GetHeaderName(MyProductActionsResources.DateTimeAction__Group, MyProductActionsResources.DateTimeAction__Header);
        }
        
        /// <summary>
        /// Заголовок колнки 'Изменение кол-ва'. Берется из ресурсов с учетов группы.
        /// </summary>
        public static string GetHeaderOfColumn_AmountChange()
        {
            return GenerationHelper.GetHeaderName(MyProductActionsResources.AmountChange__Group, MyProductActionsResources.AmountChange__Header);
        }
        
        /// <summary>
        /// Заголовок колнки 'Примечание'. Берется из ресурсов с учетов группы.
        /// </summary>
        public static string GetHeaderOfColumn_Note()
        {
            return GenerationHelper.GetHeaderName(MyProductActionsResources.Note__Group, MyProductActionsResources.Note__Header);
        }
        
        #endregion

        #region Nested type: ControlInfo

        public partial class ControlInfo : BaseControlInfo
        {
            private Dictionary<string, object> savedValues;
            private MyProductActionsEdit edit;
            private ComboBox _refProductControl;
            
            SelectParameters _refProductSelectParameters;
            
            public string Get_refProductAdditionalInfo()
            {
                var info = new SelectColumnParameters();
                info.SelectParameters = Get_refProductSelectParameters();
                info.FieldName = "refProduct";
                info.FieldInfoItems = new ExtNetSelectColumnParameters.ExtNetFieldInfo[] {};
                return new JavaScriptSerializer().Serialize(info);
            }
            
            public SelectParameters Get_refProductSelectParameters()
            {
                if (_refProductSelectParameters == null)
                    Init_refProductSelectParameters();
                return _refProductSelectParameters;
            }
            
            private void Init_refProductSelectParameters()
            {
                var parameters = new SelectParameters();
                parameters.SessionKey = edit.SessionKey;
                parameters.FieldName = "refProduct";
                if (!parameters.LoadFromSession())
                {
                    bool isKz = LocalizationHelper.IsCultureKZ;
                     parameters.SaveToSession();
                }
                _refProductSelectParameters = parameters;
            }
            private DatePicker _DateTimeActionControl;
            
            
            private NullableTextBox _AmountChangeControl;
            public const int AmountChangeLength = 7;
            public const int AmountChangePrecision = 2;
            
            private TextBox _NoteControl;
            public const int NoteLength = 500;
            
            private bool isWireToChangesEvents;
            private bool isWireToEditFieldEvents;
            private DBDataContext _db;

            public DBDataContext DB
            {
                get
                {
                    if (_db == null)
                    {
                        _db = new DBDataContext(SpecificInstances.DbFactory.CreateConnection());
                    }

                    return _db;
                }
                set
                {
                    _db = value;
                }
            }

            public ControlInfo(MyProductActionsEdit edit)
                : base (edit.FormPanelMyProductActions)
            {
                this.edit = edit;
                GetSelectedValue = () => edit.SelectedValueKey.ToString();
            }


            /// <summary>
            /// Мой товар.
            /// </summary>
            public long? refProduct
            {
                get 
                {
                    edit.EnsureInitedDefaultValue(typeof(MyProduct));
                    var value = refProductControl != null ? (refProductControl.SelectedItem == null ? null : refProductControl.SelectedItem.Value) : null;
                    if (string.IsNullOrEmpty(value))
                        return null;
                    return Convert.ToInt64(value);
                }
                set
                {
                    if (value == refProduct)
                        return;
                    string text;
                    if (value == null)
                        text = string.Empty;
                    else
                        text = MyProductActionsCacheNames.GetByTime_refProduct(DB, value.Value);
                    object[] additionalValues = null;
            
                    if (value != null)
                    {
                        var data = 
                            new[]
                                {
                                    new
                                        {
                                            id = value.Value,
                                            RowName = text,
                                            AdditionalValues = additionalValues == null ? null : JSON.Serialize(additionalValues),
                                        },
                                };
                        if (edit.Page.IsPostBack)
                            edit.Store_refProduct.LoadData(data, true);
                        else
                            edit.Store_refProduct.Data = data;
                        refProductControl.SelectedItem.Value = value.ToString();
                        refProductControl.SelectedItem.Text = text;
                        refProductControl.SelectedItem.Mode = ParameterMode.Raw;
                    }
                    else
                    {
                        refProductControl.SelectedItem.Value = string.Empty;
                        refProductControl.SelectedItem.Text = string.Empty;
                        refProductControl.SelectedItem.Mode = ParameterMode.Raw;
                    }
            
                    refProductControl.SetValueAndFireSelect(value);
                }
            }

            /// <summary>
            /// Контрол поля "Мой товар".
            /// </summary>
            public ComboBox refProductControl
            {
                get
                {
                    if (_refProductControl == null)
                        _refProductControl = (ComboBox)FindControl("lookuprefProduct");
                    return _refProductControl;
                }
            }

            /// <summary>
            /// Флаг об изменении пользователем значения поля "Мой товар", за последний раз.
            /// </summary>
            public bool IsrefProductChanged { get; set; }

            /// <summary>
            /// Дата/время действия.
            /// </summary>
            public DateTime? DateTimeAction
            {
                get
                {
                    if (DateTimeActionControl.IsEmpty)
                        return null;
                    var value = DateTimeActionControl.RawValue;
            
                    return Convert.ToDateTime(value);
                }
                set
                {
                    DateTimeActionControl.RawValue = string.Format("{0:d}", value);DateTimeActionControl.SetValue(value);
                }
            }

            /// <summary>
            /// Контрол поля "Дата/время действия".
            /// </summary>
            public DatePicker DateTimeActionControl
            {
                get
                {
                    if (_DateTimeActionControl == null)
                        _DateTimeActionControl = (DatePicker)FindControl("dpDateTimeAction");
                    return _DateTimeActionControl;
                }
            }

            /// <summary>
            /// Флаг об изменении пользователем значения поля "Дата/время действия", за последний раз.
            /// </summary>
            public bool IsDateTimeActionChanged { get; set; }

            /// <summary>
            /// Изменение кол-ва.
            /// </summary>
            public Decimal? AmountChange
            {
                get
                {
                    if (AmountChangeControl.IsEmpty)
                        return null;
                    var value = AmountChangeControl.Number;
            
                    return Convert.ToDecimal(value);
                }
                set
                {
                    AmountChangeControl.SetValue(value);
                }
            }

            /// <summary>
            /// Контрол поля "Изменение кол-ва".
            /// </summary>
            public NullableTextBox AmountChangeControl
            {
                get
                {
                    if (_AmountChangeControl == null)
                        _AmountChangeControl = (NullableTextBox)FindControl("tbAmountChange");
                    return _AmountChangeControl;
                }
            }

            /// <summary>
            /// Флаг об изменении пользователем значения поля "Изменение кол-ва", за последний раз.
            /// </summary>
            public bool IsAmountChangeChanged { get; set; }

            /// <summary>
            /// Примечание.
            /// </summary>
            public String Note
            {
                get
                {
                    if (NoteControl.IsEmpty)
                        return null;
                    var value = NoteControl.Text;
            
                    return Convert.ToString(value);
                }
                set
                {
                    NoteControl.SetValue(value);
                }
            }

            /// <summary>
            /// Контрол поля "Примечание".
            /// </summary>
            public TextBox NoteControl
            {
                get
                {
                    if (_NoteControl == null)
                        _NoteControl = (TextBox)FindControl("tbNote");
                    return _NoteControl;
                }
            }

            /// <summary>
            /// Флаг об изменении пользователем значения поля "Примечание", за последний раз.
            /// </summary>
            public bool IsNoteChanged { get; set; }

            public override void WireToChangesEvent()
            {
                if (edit.SelectedValueKey != null && edit.IsRead || isWireToChangesEvents || (edit.SelectedValueKey != null && !edit.IsNew && !edit.IsRead && string.IsNullOrEmpty(SelectedValue)))
                    return;

                isWireToChangesEvents = true;
                refProductControl.ValueChanged += delegate { IsrefProductChanged = true; };
                
                AmountChangeControl.TextChanged += delegate { IsAmountChangeChanged = true; };
                NoteControl.TextChanged += delegate { IsNoteChanged = true; };
            }

            public override void WireToEditFieldEvents()
            {
                if (isWireToEditFieldEvents || (!(edit.IsNew) && string.IsNullOrEmpty(SelectedValue))) 
                    return;

                isWireToEditFieldEvents = true;
            }

            public override void ClearRefToControls()
            {
                _refProductControl = null;
                _DateTimeActionControl = null;
                _AmountChangeControl = null;
                _NoteControl = null;
                isWireToChangesEvents = false;
                isWireToEditFieldEvents = false;
            }

            public override bool HasSavedValues
            {
                get { return savedValues != null; }
            }

            public override void SaveValues()
            {
                if (savedValues == null)
                    savedValues = new Dictionary<string, object>();
                else
                    savedValues.Clear();

                savedValues.Add("refProduct", refProductControl.Text);
                savedValues.Add("DateTimeAction", DateTimeAction);
                savedValues.Add("AmountChange", AmountChangeControl.Text);
                savedValues.Add("Note", NoteControl.Text);
            }

            public override void LoadValues()
            {
                if (savedValues == null)
                    throw new NullReferenceException("Before execute LoadValues need execute SaveValues");

                refProductControl.Text = (string)savedValues["refProduct"];
                DateTimeAction = (DateTime)savedValues["DateTimeAction"];
                AmountChangeControl.Text = (string)savedValues["AmountChange"];
                NoteControl.Text = (string)savedValues["Note"];
            }

            public override void SetValue(string property, object value, string text, string alternativeText)
            {
                switch (property)
                {
                    case "refProduct":
                        refProduct = (Int64)value;
                        break;
                    default:
                        throw new Exception(string.Format("property '{0}' not exist in table 'MyProductActions'", property));
                }
            }

/*
            private IList<WebControl> _controls;
            public IList<WebControl> Controls
            {
                get
                {
                    if (_controls == null)
                    {
                        _controls = new List<WebControl>
                                        {
                                            refProductControl,
                                            DateTimeActionControl,
                                            AmountChangeControl,
                                            NoteControl,
                                        };
                    }
                    return _controls;
                }
            }*/
        }

        public partial class RecordEvents : BaseRecordEvents<long, MyProductAction>
        {
            private DBDataContext _db;
        
            protected DBDataContext DB
            {
                get
                {
                    if (_db == null)
                    {
                        _db = new DBDataContext(SpecificInstances.DbFactory.CreateConnection());
                    }
        
                    return _db;
                }
            }
        
            public long? MyProductActions
            {
                get
                {
                    if (!Values.ContainsKey(typeof(MyProductAction))) return null;
                    return (long?)Values[typeof(MyProductAction)];
                }
                set
                {
                    Values[typeof(MyProductAction)] = value;
                }
            }
            
            public long? MyProducts
            {
                get
                {
                    if (!Values.ContainsKey(typeof(MyProduct))) return null;
                    return (long?)Values[typeof(MyProduct)];
                }
                set
                {
                    Values[typeof(MyProduct)] = value;
                }
            }
        
            /// <summary>
            /// Не трогать!!! :)
            /// </summary>
            public MyProductActionsJournalDataSourceView.Row SelectedRow { get; set; }
        }

        #endregion
    }
}